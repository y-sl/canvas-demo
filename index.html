<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯è§†åŒ–é¡µé¢æ­å»ºåŸå‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <style>
        /* è‡ªå®šä¹‰æ ·å¼ */
        .phone-preview {
            width: 375px;
            height: 667px;
            background: #000;
            border-radius: 25px;
            padding: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
        }
        
        .phone-screen {
            width: 100%;
            height: 100%;
            background: #fff;
            border-radius: 15px;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
        }
        
        .canvas-container {
            width: 100%;
            height: 600px;
            border: 2px dashed #e5e7eb;
            background: #f9fafb;
            position: relative;
            overflow: hidden;
        }
        
        .property-panel {
            height: 600px;
            overflow-y: auto;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .module-preview {
            position: absolute;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .module-preview:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #374151;
        }
        
        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s ease;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s ease;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        
        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }
        
        .alert-error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- æ ‡é¢˜æ  -->
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">å¯è§†åŒ–é¡µé¢æ­å»ºåŸå‹</h1>
            <p class="text-gray-600">ä½¿ç”¨æ‹–æ‹½æ–¹å¼åˆ›å»ºæ´»åŠ¨é¡µé¢ï¼Œæ”¯æŒå¤šç§æ¨¡å—ç±»å‹å’Œå®æ—¶é¢„è§ˆ</p>
        </div>
        
        <!-- ä¸‰æ å¸ƒå±€ -->
        <div class="grid grid-cols-12 gap-6">
            <!-- å·¦æ ï¼šç®¡ç†åå°/ç”»å¸ƒåŒº -->
            <div class="col-span-4">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-gray-900">ç®¡ç†åå°</h2>
                        <div class="flex gap-2">
                            <input type="file" id="backgroundUpload" accept="image/*" class="hidden">
                            <button id="uploadBtn" class="btn-primary">ä¸Šä¼ èƒŒæ™¯å›¾</button>
                            <button id="saveConfigBtn" class="btn-secondary">ä¿å­˜é…ç½®</button>
                        </div>
                    </div>
                    
                    <!-- ç”»å¸ƒå®¹å™¨ -->
                    <div class="canvas-container">
                        <canvas id="fabricCanvas"></canvas>
                        <div id="canvasOverlay" class="absolute inset-0 pointer-events-none">
                            <div id="dragHint" class="hidden absolute bg-blue-500 bg-opacity-20 border-2 border-blue-500 border-dashed"></div>
                            <div id="canvasLoading" class="hidden absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center">
                                <div class="text-center">
                                    <div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-2"></div>
                                    <div class="text-sm text-gray-600">æ­£åœ¨è®¾ç½®èƒŒæ™¯å›¾ç‰‡...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ“ä½œæç¤º -->
                    <div class="mt-4 text-sm text-gray-600">
                        <p>ğŸ’¡ æ“ä½œæç¤ºï¼š</p>
                        <ul class="list-disc list-inside mt-2 space-y-1">
                            <li>å…ˆä¸Šä¼ èƒŒæ™¯å›¾ç‰‡</li>
                            <li>æŒ‰ä½é¼ æ ‡æ‹–æ‹½åˆ›å»ºæ¨¡å—</li>
                            <li>ç‚¹å‡»æ¨¡å—è¿›è¡Œé€‰æ‹©å’Œç¼–è¾‘</li>
                            <li>æ‹–æ‹½æ¨¡å—è¾¹ç¼˜è°ƒæ•´å¤§å°</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- ä¸­æ ï¼šå±æ€§é…ç½®é¢æ¿ -->
            <div class="col-span-4">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">å±æ€§é…ç½®</h2>
                    
                    <!-- å±æ€§é¢æ¿å®¹å™¨ -->
                    <div class="property-panel">
                        <div id="propertyContent">
                            <div class="alert alert-info">
                                <p>è¯·åœ¨å·¦ä¾§ç”»å¸ƒä¸­æ‹–æ‹½åˆ›å»ºæˆ–é€‰æ‹©ä¸€ä¸ªæ¨¡å—</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å³æ ï¼šH5å®æ—¶é¢„è§ˆ -->
            <div class="col-span-4">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">å®æ—¶é¢„è§ˆ</h2>
                    
                    <!-- æ‰‹æœºé¢„è§ˆå®¹å™¨ -->
                    <div class="flex justify-center">
                        <div class="phone-preview">
                            <div class="phone-screen">
                                <div id="previewContainer" class="w-full h-full relative overflow-hidden">
                                    <div id="previewBackground" class="w-full h-full absolute inset-0 bg-gray-100 flex items-center justify-center text-gray-500">
                                        <p>è¯·å…ˆä¸Šä¼ èƒŒæ™¯å›¾ç‰‡</p>
                                    </div>
                                    <div id="previewModules" class="absolute inset-0"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- é¢„è§ˆæ§åˆ¶ -->
                    <div class="mt-4 flex justify-center gap-2">
                        <button id="previewRefreshBtn" class="btn-secondary">åˆ·æ–°é¢„è§ˆ</button>
                        <button id="previewResetBtn" class="btn-secondary">é‡ç½®è§†å›¾</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é…ç½®å¯¼å‡ºå¼¹çª— -->
        <div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">å¯¼å‡ºé…ç½®</h3>
                    <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="mb-4">
                    <label class="form-label">é…ç½®JSONï¼š</label>
                    <textarea id="configOutput" class="form-input h-64 font-mono text-sm" readonly></textarea>
                </div>
                <div class="flex justify-end gap-2">
                    <button id="copyConfigBtn" class="btn-primary">å¤åˆ¶é…ç½®</button>
                    <button id="downloadConfigBtn" class="btn-secondary">ä¸‹è½½é…ç½®</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // åº”ç”¨ç¨‹åºå°†åœ¨è¿™é‡Œåˆå§‹åŒ–
        console.log('å¯è§†åŒ–é¡µé¢æ­å»ºåŸå‹å·²åŠ è½½');
        console.log('Fabric.jsç‰ˆæœ¬:', fabric.version);
        
        // ==================== æ ¸å¿ƒæ¨¡å—ç±»ç³»ç»Ÿ ====================
        
        /**
         * åŸºç¡€æ¨¡å—ç±» - æ‰€æœ‰æ¨¡å—ç±»å‹çš„åŸºç±»
         */
        class BaseModule {
            constructor(id, type, fabricObject, properties = {}) {
                this.id = id || this.generateId();
                this.type = type;
                this.fabricObject = fabricObject;
                this.properties = { ...this.getDefaultProperties(), ...properties };
                this.created = new Date().toISOString();
                
                // ç»‘å®šFabricå¯¹è±¡å’Œæ¨¡å—å®ä¾‹
                if (this.fabricObject) {
                    this.fabricObject.moduleInstance = this;
                    this.fabricObject.selectable = true;
                    this.fabricObject.hasControls = true;
                    this.fabricObject.hasBorders = true;
                }
            }
            
            /**
             * ç”Ÿæˆå”¯ä¸€ID
             */
            generateId() {
                return 'module_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            /**
             * è·å–é»˜è®¤å±æ€§ï¼ˆå­ç±»éœ€è¦é‡å†™ï¼‰
             */
            getDefaultProperties() {
                return {};
            }
            
            /**
             * åºåˆ—åŒ–æ¨¡å—æ•°æ®ä¸ºJSONæ ¼å¼
             */
            serialize(backgroundWidth, backgroundHeight) {
                const rect = this.getPercentageRect(backgroundWidth, backgroundHeight);
                return {
                    id: this.id,
                    type: this.type,
                    rect: rect,
                    properties: { ...this.properties },
                    created: this.created
                };
            }
            
            /**
             * ä»JSONæ•°æ®ååºåˆ—åŒ–æ¨¡å—
             */
            static deserialize(data, canvas) {
                // è¿™ä¸ªæ–¹æ³•åœ¨å­ç±»ä¸­å®ç°
                throw new Error('deserialize method must be implemented in subclass');
            }
            
            /**
             * æ›´æ–°æ¨¡å—å±æ€§
             */
            updateProperties(newProperties) {
                this.properties = { ...this.properties, ...newProperties };
                this.applyPropertiesToFabric();
                this.onPropertiesChanged();
            }
            
            /**
             * å°†å±æ€§åº”ç”¨åˆ°Fabricå¯¹è±¡ï¼ˆå­ç±»éœ€è¦é‡å†™ï¼‰
             */
            applyPropertiesToFabric() {
                // å­ç±»å®ç°å…·ä½“çš„å±æ€§åº”ç”¨é€»è¾‘
            }
            
            /**
             * å±æ€§å˜æ›´å›è°ƒ
             */
            onPropertiesChanged() {
                // è§¦å‘é¢„è§ˆæ›´æ–°
                if (window.previewManager) {
                    window.previewManager.updateModule(this);
                }
            }
            
            /**
             * åœ¨é¢„è§ˆå®¹å™¨ä¸­æ¸²æŸ“æ¨¡å—
             */
            renderPreview(container, containerWidth, containerHeight) {
                // å­ç±»å®ç°å…·ä½“çš„é¢„è§ˆæ¸²æŸ“é€»è¾‘
                throw new Error('renderPreview method must be implemented in subclass');
            }
            
            /**
             * è·å–ç›¸å¯¹äºèƒŒæ™¯å›¾çš„ç™¾åˆ†æ¯”ä½ç½®å’Œå°ºå¯¸
             */
            getPercentageRect(backgroundWidth, backgroundHeight) {
                if (!this.fabricObject || !backgroundWidth || !backgroundHeight) {
                    return { left: '0%', top: '0%', width: '100%', height: '10%' };
                }
                
                const obj = this.fabricObject;
                const left = this.toPercentage(obj.left, backgroundWidth);
                const top = this.toPercentage(obj.top, backgroundHeight);
                const width = this.toPercentage(obj.width * obj.scaleX, backgroundWidth);
                const height = this.toPercentage(obj.height * obj.scaleY, backgroundHeight);
                
                return { left, top, width, height };
            }
            
            /**
             * è½¬æ¢ä¸ºç™¾åˆ†æ¯”
             */
            toPercentage(value, dimension) {
                return ((value / dimension) * 100).toFixed(2) + '%';
            }
            
            /**
             * ä»ç™¾åˆ†æ¯”è½¬æ¢ä¸ºåƒç´ å€¼
             */
            fromPercentage(percentage, dimension) {
                return (parseFloat(percentage) / 100) * dimension;
            }
            
            /**
             * è·å–æ¨¡å—çš„æ˜¾ç¤ºåç§°
             */
            getDisplayName() {
                const typeNames = {
                    'TEXT': 'æ–‡æœ¬',
                    'BUTTON': 'æŒ‰é’®',
                    'VIDEO': 'è§†é¢‘',
                    'GIF': 'åŠ¨æ€å›¾'
                };
                return typeNames[this.type] || this.type;
            }
            
            /**
             * è·å–æ¨¡å—çš„å›¾æ ‡
             */
            getIcon() {
                const icons = {
                    'TEXT': 'ğŸ“',
                    'BUTTON': 'ğŸ”˜',
                    'VIDEO': 'ğŸ¬',
                    'GIF': 'ğŸï¸'
                };
                return icons[this.type] || 'ğŸ“„';
            }
            
            /**
             * éªŒè¯æ¨¡å—å±æ€§
             */
            validateProperties() {
                // å­ç±»å¯ä»¥é‡å†™æ­¤æ–¹æ³•è¿›è¡Œç‰¹å®šéªŒè¯
                return { valid: true, errors: [] };
            }
            
            /**
             * æ¸…ç†æ¨¡å—èµ„æº
             */
            destroy() {
                if (this.fabricObject) {
                    this.fabricObject.moduleInstance = null;
                }
                this.fabricObject = null;
                this.properties = null;
            }
            
            /**
             * å…‹éš†æ¨¡å—
             */
            clone() {
                const clonedData = this.serialize(1000, 1000); // ä½¿ç”¨ä¸´æ—¶å°ºå¯¸
                clonedData.id = this.generateId();
                return this.constructor.deserialize(clonedData, null);
            }
        }
        
        // ==================== å·¥å…·å‡½æ•° ====================
        
        /**
         * åæ ‡è½¬æ¢å·¥å…·å‡½æ•°
         */
        const CoordinateUtils = {
            /**
             * è½¬æ¢ä¸ºç™¾åˆ†æ¯”
             */
            toPercentage(value, dimension) {
                return ((value / dimension) * 100).toFixed(2) + '%';
            },
            
            /**
             * ä»ç™¾åˆ†æ¯”è½¬æ¢ä¸ºåƒç´ å€¼
             */
            fromPercentage(percentage, dimension) {
                return (parseFloat(percentage) / 100) * dimension;
            },
            
            /**
             * è®¡ç®—ç”»å¸ƒç¼©æ”¾æ¯”ä¾‹
             */
            calculateCanvasScale(containerWidth, imageWidth) {
                return Math.min(containerWidth / imageWidth, 1);
            },
            
            /**
             * é™åˆ¶å€¼åœ¨æŒ‡å®šèŒƒå›´å†…
             */
            clamp(value, min, max) {
                return Math.min(Math.max(value, min), max);
            }
        };
        
        /**
         * æ–‡ä»¶å¤„ç†å·¥å…·å‡½æ•°
         */
        const FileUtils = {
            /**
             * å°†æ–‡ä»¶è½¬æ¢ä¸ºbase64
             */
            async fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            },
            
            /**
             * éªŒè¯æ–‡ä»¶ç±»å‹
             */
            validateImageFile(file) {
                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                return allowedTypes.includes(file.type);
            },
            
            /**
             * éªŒè¯æ–‡ä»¶å¤§å°
             */
            validateFileSize(file, maxSizeMB = 10) {
                return file.size <= maxSizeMB * 1024 * 1024;
            }
        };
        
        /**
         * DOMæ“ä½œå·¥å…·å‡½æ•°
         */
        const DOMUtils = {
            /**
             * åˆ›å»ºDOMå…ƒç´ 
             */
            createElement(tag, className, textContent) {
                const element = document.createElement(tag);
                if (className) element.className = className;
                if (textContent) element.textContent = textContent;
                return element;
            },
            
            /**
             * æ¸…ç©ºå®¹å™¨
             */
            clearContainer(container) {
                while (container.firstChild) {
                    container.removeChild(container.firstChild);
                }
            },
            
            /**
             * æ˜¾ç¤º/éšè—å…ƒç´ 
             */
            toggleVisibility(element, show) {
                if (show) {
                    element.classList.remove('hidden');
                    element.classList.add('flex');
                } else {
                    element.classList.add('hidden');
                    element.classList.remove('flex');
                }
            }
        };
        
        console.log('BaseModuleåŸºç±»å·²åŠ è½½');
        
        // ==================== å…·ä½“æ¨¡å—ç±»å®ç° ====================
        
        /**
         * æ–‡æœ¬æ¨¡å—ç±»
         */
        class TextModule extends BaseModule {
            constructor(id, fabricObject, properties = {}) {
                super(id, 'TEXT', fabricObject, properties);
            }
            
            /**
             * è·å–é»˜è®¤å±æ€§
             */
            getDefaultProperties() {
                return {
                    textContent: 'è¯·è¾“å…¥æ–‡æœ¬å†…å®¹',
                    fontSize: 16,
                    color: '#000000',
                    fontWeight: 'normal',
                    textAlign: 'left',
                    fontFamily: 'Arial, sans-serif',
                    lineHeight: 1.4,
                    letterSpacing: 0
                };
            }
            
            /**
             * å°†å±æ€§åº”ç”¨åˆ°Fabricå¯¹è±¡
             */
            applyPropertiesToFabric() {
                if (!this.fabricObject) return;
                
                const props = this.properties;
                
                // æ›´æ–°æ–‡æœ¬å†…å®¹
                this.fabricObject.set('text', props.textContent);
                
                // æ›´æ–°å­—ä½“æ ·å¼
                this.fabricObject.set({
                    fontSize: props.fontSize,
                    fill: props.color,
                    fontWeight: props.fontWeight,
                    textAlign: props.textAlign,
                    fontFamily: props.fontFamily,
                    lineHeight: props.lineHeight,
                    charSpacing: props.letterSpacing * 1000 // Fabric.jsä½¿ç”¨1000å€çš„å­—ç¬¦é—´è·
                });
                
                // åˆ·æ–°ç”»å¸ƒ
                if (this.fabricObject.canvas) {
                    this.fabricObject.canvas.renderAll();
                }
            }
            
            /**
             * åˆ›å»ºFabricæ–‡æœ¬å¯¹è±¡
             */
            static createFabricObject(text, options = {}) {
                const defaultOptions = {
                    left: options.left || 50,
                    top: options.top || 50,
                    fontSize: options.fontSize || 16,
                    fill: options.color || '#000000',
                    fontWeight: options.fontWeight || 'normal',
                    textAlign: options.textAlign || 'left',
                    fontFamily: options.fontFamily || 'Arial, sans-serif',
                    lineHeight: options.lineHeight || 1.4,
                    charSpacing: (options.letterSpacing || 0) * 1000
                };
                
                return new fabric.Text(text, defaultOptions);
            }
            
            /**
             * åœ¨é¢„è§ˆå®¹å™¨ä¸­æ¸²æŸ“æ¨¡å—
             */
            renderPreview(container, containerWidth, containerHeight) {
                const rect = this.getPercentageRect(containerWidth, containerHeight);
                const props = this.properties;
                
                // åˆ›å»ºæ–‡æœ¬å…ƒç´ 
                const textElement = DOMUtils.createElement('div', 'module-preview');
                textElement.style.cssText = `
                    position: absolute;
                    left: ${rect.left};
                    top: ${rect.top};
                    width: ${rect.width};
                    height: ${rect.height};
                    font-size: ${props.fontSize}px;
                    color: ${props.color};
                    font-weight: ${props.fontWeight};
                    text-align: ${props.textAlign};
                    font-family: ${props.fontFamily};
                    line-height: ${props.lineHeight};
                    letter-spacing: ${props.letterSpacing}px;
                    overflow: hidden;
                    word-wrap: break-word;
                    display: flex;
                    align-items: center;
                    padding: 4px;
                    box-sizing: border-box;
                    z-index: 10;
                `;
                
                textElement.textContent = props.textContent;
                textElement.dataset.moduleId = this.id;
                textElement.dataset.moduleType = this.type;
                
                return textElement;
            }
            
            /**
             * ä»JSONæ•°æ®ååºåˆ—åŒ–æ–‡æœ¬æ¨¡å—
             */
            static deserialize(data, canvas) {
                const fabricObject = TextModule.createFabricObject(
                    data.properties.textContent,
                    {
                        left: CoordinateUtils.fromPercentage(data.rect.left, canvas ? canvas.width : 375),
                        top: CoordinateUtils.fromPercentage(data.rect.top, canvas ? canvas.height : 667),
                        fontSize: data.properties.fontSize,
                        color: data.properties.color,
                        fontWeight: data.properties.fontWeight,
                        textAlign: data.properties.textAlign,
                        fontFamily: data.properties.fontFamily,
                        lineHeight: data.properties.lineHeight,
                        letterSpacing: data.properties.letterSpacing
                    }
                );
                
                // è®¾ç½®å°ºå¯¸
                const width = CoordinateUtils.fromPercentage(data.rect.width, canvas ? canvas.width : 375);
                const height = CoordinateUtils.fromPercentage(data.rect.height, canvas ? canvas.height : 667);
                fabricObject.set({ width, height });
                
                const module = new TextModule(data.id, fabricObject, data.properties);
                
                if (canvas) {
                    canvas.add(fabricObject);
                }
                
                return module;
            }
            
            /**
             * éªŒè¯æ–‡æœ¬æ¨¡å—å±æ€§
             */
            validateProperties() {
                const errors = [];
                const props = this.properties;
                
                if (!props.textContent || props.textContent.trim() === '') {
                    errors.push('æ–‡æœ¬å†…å®¹ä¸èƒ½ä¸ºç©º');
                }
                
                if (props.fontSize < 8 || props.fontSize > 72) {
                    errors.push('å­—ä½“å¤§å°å¿…é¡»åœ¨8-72pxä¹‹é—´');
                }
                
                if (!props.color || !props.color.match(/^#[0-9A-Fa-f]{6}$/)) {
                    errors.push('é¢œè‰²æ ¼å¼ä¸æ­£ç¡®');
                }
                
                if (props.lineHeight < 0.5 || props.lineHeight > 3) {
                    errors.push('è¡Œé«˜å¿…é¡»åœ¨0.5-3ä¹‹é—´');
                }
                
                return {
                    valid: errors.length === 0,
                    errors: errors
                };
            }
            
            /**
             * è·å–å±æ€§é…ç½®è¡¨å•å­—æ®µ
             */
            getPropertyFields() {
                return [
                    {
                        key: 'textContent',
                        label: 'æ–‡æœ¬å†…å®¹',
                        type: 'textarea',
                        required: true,
                        placeholder: 'è¯·è¾“å…¥æ–‡æœ¬å†…å®¹'
                    },
                    {
                        key: 'fontSize',
                        label: 'å­—ä½“å¤§å°',
                        type: 'number',
                        min: 8,
                        max: 72,
                        unit: 'px'
                    },
                    {
                        key: 'color',
                        label: 'æ–‡å­—é¢œè‰²',
                        type: 'color'
                    },
                    {
                        key: 'fontWeight',
                        label: 'å­—ä½“ç²—ç»†',
                        type: 'select',
                        options: [
                            { value: 'normal', label: 'æ­£å¸¸' },
                            { value: 'bold', label: 'ç²—ä½“' },
                            { value: '100', label: 'æç»†' },
                            { value: '300', label: 'ç»†ä½“' },
                            { value: '500', label: 'ä¸­ç­‰' },
                            { value: '700', label: 'ç²—ä½“' },
                            { value: '900', label: 'æç²—' }
                        ]
                    },
                    {
                        key: 'textAlign',
                        label: 'æ–‡æœ¬å¯¹é½',
                        type: 'select',
                        options: [
                            { value: 'left', label: 'å·¦å¯¹é½' },
                            { value: 'center', label: 'å±…ä¸­' },
                            { value: 'right', label: 'å³å¯¹é½' },
                            { value: 'justify', label: 'ä¸¤ç«¯å¯¹é½' }
                        ]
                    },
                    {
                        key: 'fontFamily',
                        label: 'å­—ä½“',
                        type: 'select',
                        options: [
                            { value: 'Arial, sans-serif', label: 'Arial' },
                            { value: '"Microsoft YaHei", sans-serif', label: 'å¾®è½¯é›…é»‘' },
                            { value: '"PingFang SC", sans-serif', label: 'è‹¹æ–¹' },
                            { value: '"Helvetica Neue", sans-serif', label: 'Helvetica' },
                            { value: 'serif', label: 'è¡¬çº¿å­—ä½“' },
                            { value: 'monospace', label: 'ç­‰å®½å­—ä½“' }
                        ]
                    },
                    {
                        key: 'lineHeight',
                        label: 'è¡Œé«˜',
                        type: 'number',
                        min: 0.5,
                        max: 3,
                        step: 0.1
                    },
                    {
                        key: 'letterSpacing',
                        label: 'å­—ç¬¦é—´è·',
                        type: 'number',
                        min: -5,
                        max: 10,
                        step: 0.1,
                        unit: 'px'
                    }
                ];
            }
        }
        
        console.log('TextModuleç±»å·²åŠ è½½');
        
        /**
         * æŒ‰é’®æ¨¡å—ç±»
         */
        class ButtonModule extends BaseModule {
            constructor(id, fabricObject, properties = {}) {
                super(id, 'BUTTON', fabricObject, properties);
            }
            
            /**
             * è·å–é»˜è®¤å±æ€§
             */
            getDefaultProperties() {
                return {
                    buttonText: 'ç‚¹å‡»æŒ‰é’®',
                    backgroundColor: '#3b82f6',
                    textColor: '#ffffff',
                    fontSize: 16,
                    fontWeight: 'normal',
                    borderRadius: 6,
                    borderWidth: 0,
                    borderColor: '#d1d5db',
                    actionType: 'SHOW_TOAST',
                    actionData: {
                        text: 'æŒ‰é’®è¢«ç‚¹å‡»äº†ï¼',
                        url: '',
                        duration: 3000
                    }
                };
            }
            
            /**
             * å°†å±æ€§åº”ç”¨åˆ°Fabricå¯¹è±¡
             */
            applyPropertiesToFabric() {
                if (!this.fabricObject) return;
                
                const props = this.properties;
                
                // æ›´æ–°çŸ©å½¢æ ·å¼
                this.fabricObject.set({
                    fill: props.backgroundColor,
                    stroke: props.borderColor,
                    strokeWidth: props.borderWidth,
                    rx: props.borderRadius,
                    ry: props.borderRadius
                });
                
                // æ›´æ–°æ–‡æœ¬ï¼ˆå¦‚æœæœ‰æ–‡æœ¬å¯¹è±¡ï¼‰
                if (this.fabricObject.type === 'group' && this.fabricObject.getObjects().length > 1) {
                    const textObject = this.fabricObject.getObjects()[1];
                    if (textObject) {
                        textObject.set({
                            text: props.buttonText,
                            fontSize: props.fontSize,
                            fill: props.textColor,
                            fontWeight: props.fontWeight
                        });
                    }
                }
                
                // åˆ·æ–°ç”»å¸ƒ
                if (this.fabricObject.canvas) {
                    this.fabricObject.canvas.renderAll();
                }
            }
            
            /**
             * åˆ›å»ºFabricæŒ‰é’®å¯¹è±¡ï¼ˆçŸ©å½¢+æ–‡æœ¬ç»„åˆï¼‰
             */
            static createFabricObject(text, options = {}) {
                const defaultOptions = {
                    left: options.left || 50,
                    top: options.top || 50,
                    width: options.width || 120,
                    height: options.height || 40,
                    backgroundColor: options.backgroundColor || '#3b82f6',
                    textColor: options.textColor || '#ffffff',
                    fontSize: options.fontSize || 16,
                    fontWeight: options.fontWeight || 'normal',
                    borderRadius: options.borderRadius || 6,
                    borderWidth: options.borderWidth || 0,
                    borderColor: options.borderColor || '#d1d5db'
                };
                
                // åˆ›å»ºçŸ©å½¢èƒŒæ™¯
                const rect = new fabric.Rect({
                    left: 0,
                    top: 0,
                    width: defaultOptions.width,
                    height: defaultOptions.height,
                    fill: defaultOptions.backgroundColor,
                    stroke: defaultOptions.borderColor,
                    strokeWidth: defaultOptions.borderWidth,
                    rx: defaultOptions.borderRadius,
                    ry: defaultOptions.borderRadius
                });
                
                // åˆ›å»ºæ–‡æœ¬
                const textObj = new fabric.Text(text, {
                    left: defaultOptions.width / 2,
                    top: defaultOptions.height / 2,
                    fontSize: defaultOptions.fontSize,
                    fill: defaultOptions.textColor,
                    fontWeight: defaultOptions.fontWeight,
                    textAlign: 'center',
                    originX: 'center',
                    originY: 'center'
                });
                
                // åˆ›å»ºç»„åˆå¯¹è±¡
                const group = new fabric.Group([rect, textObj], {
                    left: defaultOptions.left,
                    top: defaultOptions.top,
                    selectable: true,
                    hasControls: true,
                    hasBorders: true
                });
                
                return group;
            }
            
            /**
             * åœ¨é¢„è§ˆå®¹å™¨ä¸­æ¸²æŸ“æ¨¡å—
             */
            renderPreview(container, containerWidth, containerHeight) {
                const rect = this.getPercentageRect(containerWidth, containerHeight);
                const props = this.properties;
                
                // åˆ›å»ºæŒ‰é’®å…ƒç´ 
                const buttonElement = DOMUtils.createElement('button', 'module-preview');
                buttonElement.style.cssText = `
                    position: absolute;
                    left: ${rect.left};
                    top: ${rect.top};
                    width: ${rect.width};
                    height: ${rect.height};
                    background-color: ${props.backgroundColor};
                    color: ${props.textColor};
                    font-size: ${props.fontSize}px;
                    font-weight: ${props.fontWeight};
                    border: ${props.borderWidth}px solid ${props.borderColor};
                    border-radius: ${props.borderRadius}px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s ease;
                    z-index: 10;
                    outline: none;
                    font-family: inherit;
                `;
                
                buttonElement.textContent = props.buttonText;
                buttonElement.dataset.moduleId = this.id;
                buttonElement.dataset.moduleType = this.type;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                buttonElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.handleButtonClick();
                });
                
                // æ·»åŠ æ‚¬åœæ•ˆæœ
                buttonElement.addEventListener('mouseenter', () => {
                    buttonElement.style.opacity = '0.9';
                    buttonElement.style.transform = 'scale(1.02)';
                });
                
                buttonElement.addEventListener('mouseleave', () => {
                    buttonElement.style.opacity = '1';
                    buttonElement.style.transform = 'scale(1)';
                });
                
                return buttonElement;
            }
            
            /**
             * å¤„ç†æŒ‰é’®ç‚¹å‡»äº‹ä»¶
             */
            handleButtonClick() {
                const { actionType, actionData } = this.properties;
                
                switch (actionType) {
                    case 'SHOW_TOAST':
                        this.showToast(actionData.text || 'æŒ‰é’®è¢«ç‚¹å‡»äº†ï¼');
                        break;
                    case 'JUMP_URL':
                        if (actionData.url) {
                            window.open(actionData.url, '_blank');
                        } else {
                            this.showToast('æœªè®¾ç½®è·³è½¬é“¾æ¥');
                        }
                        break;
                    case 'OPEN_VIP_PAGE':
                        this.showToast('æ‰“å¼€VIPé¡µé¢åŠŸèƒ½');
                        break;
                    default:
                        this.showToast('æœªçŸ¥æ“ä½œç±»å‹');
                }
            }
            
            /**
             * æ˜¾ç¤ºToastæç¤º
             */
            showToast(message) {
                // åˆ›å»ºToastå…ƒç´ 
                const toast = DOMUtils.createElement('div', 'fixed top-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 transform transition-all duration-300');
                toast.textContent = message;
                
                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(toast);
                
                // æ˜¾ç¤ºåŠ¨ç”»
                setTimeout(() => {
                    toast.classList.add('translate-x-0');
                    toast.classList.remove('translate-x-full');
                }, 100);
                
                // è‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    toast.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, 2000);
            }
            
            /**
             * ä»JSONæ•°æ®ååºåˆ—åŒ–æŒ‰é’®æ¨¡å—
             */
            static deserialize(data, canvas) {
                const fabricObject = ButtonModule.createFabricObject(
                    data.properties.buttonText,
                    {
                        left: CoordinateUtils.fromPercentage(data.rect.left, canvas ? canvas.width : 375),
                        top: CoordinateUtils.fromPercentage(data.rect.top, canvas ? canvas.height : 667),
                        width: CoordinateUtils.fromPercentage(data.rect.width, canvas ? canvas.width : 375),
                        height: CoordinateUtils.fromPercentage(data.rect.height, canvas ? canvas.height : 667),
                        backgroundColor: data.properties.backgroundColor,
                        textColor: data.properties.textColor,
                        fontSize: data.properties.fontSize,
                        fontWeight: data.properties.fontWeight,
                        borderRadius: data.properties.borderRadius,
                        borderWidth: data.properties.borderWidth,
                        borderColor: data.properties.borderColor
                    }
                );
                
                const module = new ButtonModule(data.id, fabricObject, data.properties);
                
                if (canvas) {
                    canvas.add(fabricObject);
                }
                
                return module;
            }
            
            /**
             * éªŒè¯æŒ‰é’®æ¨¡å—å±æ€§
             */
            validateProperties() {
                const errors = [];
                const props = this.properties;
                
                if (!props.buttonText || props.buttonText.trim() === '') {
                    errors.push('æŒ‰é’®æ–‡æœ¬ä¸èƒ½ä¸ºç©º');
                }
                
                if (props.fontSize < 8 || props.fontSize > 36) {
                    errors.push('å­—ä½“å¤§å°å¿…é¡»åœ¨8-36pxä¹‹é—´');
                }
                
                if (!props.backgroundColor || !props.backgroundColor.match(/^#[0-9A-Fa-f]{6}$/)) {
                    errors.push('èƒŒæ™¯é¢œè‰²æ ¼å¼ä¸æ­£ç¡®');
                }
                
                if (!props.textColor || !props.textColor.match(/^#[0-9A-Fa-f]{6}$/)) {
                    errors.push('æ–‡å­—é¢œè‰²æ ¼å¼ä¸æ­£ç¡®');
                }
                
                if (props.borderRadius < 0 || props.borderRadius > 20) {
                    errors.push('åœ†è§’åŠå¾„å¿…é¡»åœ¨0-20pxä¹‹é—´');
                }
                
                if (props.actionType === 'JUMP_URL' && !props.actionData.url) {
                    errors.push('è·³è½¬é“¾æ¥ä¸èƒ½ä¸ºç©º');
                }
                
                return {
                    valid: errors.length === 0,
                    errors: errors
                };
            }
            
            /**
             * è·å–å±æ€§é…ç½®è¡¨å•å­—æ®µ
             */
            getPropertyFields() {
                return [
                    {
                        key: 'buttonText',
                        label: 'æŒ‰é’®æ–‡æœ¬',
                        type: 'text',
                        required: true,
                        placeholder: 'è¯·è¾“å…¥æŒ‰é’®æ–‡æœ¬'
                    },
                    {
                        key: 'backgroundColor',
                        label: 'èƒŒæ™¯é¢œè‰²',
                        type: 'color'
                    },
                    {
                        key: 'textColor',
                        label: 'æ–‡å­—é¢œè‰²',
                        type: 'color'
                    },
                    {
                        key: 'fontSize',
                        label: 'å­—ä½“å¤§å°',
                        type: 'number',
                        min: 8,
                        max: 36,
                        unit: 'px'
                    },
                    {
                        key: 'fontWeight',
                        label: 'å­—ä½“ç²—ç»†',
                        type: 'select',
                        options: [
                            { value: 'normal', label: 'æ­£å¸¸' },
                            { value: 'bold', label: 'ç²—ä½“' },
                            { value: '500', label: 'ä¸­ç­‰' },
                            { value: '700', label: 'ç²—ä½“' }
                        ]
                    },
                    {
                        key: 'borderRadius',
                        label: 'åœ†è§’åŠå¾„',
                        type: 'number',
                        min: 0,
                        max: 20,
                        unit: 'px'
                    },
                    {
                        key: 'borderWidth',
                        label: 'è¾¹æ¡†å®½åº¦',
                        type: 'number',
                        min: 0,
                        max: 5,
                        unit: 'px'
                    },
                    {
                        key: 'borderColor',
                        label: 'è¾¹æ¡†é¢œè‰²',
                        type: 'color'
                    },
                    {
                        key: 'actionType',
                        label: 'äº‹ä»¶ç±»å‹',
                        type: 'select',
                        options: [
                            { value: 'SHOW_TOAST', label: 'æ˜¾ç¤ºæç¤º' },
                            { value: 'JUMP_URL', label: 'è·³è½¬é“¾æ¥' },
                            { value: 'OPEN_VIP_PAGE', label: 'æ‰“å¼€VIPé¡µé¢' }
                        ]
                    }
                ];
            }
            
            /**
             * è·å–åŠ¨æ€é…ç½®å­—æ®µï¼ˆæ ¹æ®äº‹ä»¶ç±»å‹ï¼‰
             */
            getDynamicFields() {
                const { actionType } = this.properties;
                
                switch (actionType) {
                    case 'SHOW_TOAST':
                        return [
                            {
                                key: 'actionData.text',
                                label: 'æç¤ºæ–‡å­—',
                                type: 'text',
                                placeholder: 'è¯·è¾“å…¥æç¤ºæ–‡å­—'
                            }
                        ];
                    case 'JUMP_URL':
                        return [
                            {
                                key: 'actionData.url',
                                label: 'è·³è½¬é“¾æ¥',
                                type: 'url',
                                placeholder: 'https://example.com',
                                required: true
                            }
                        ];
                    case 'OPEN_VIP_PAGE':
                        return []; // æ— éœ€é¢å¤–é…ç½®
                    default:
                        return [];
                }
            }
        }
        
        console.log('ButtonModuleç±»å·²åŠ è½½');
        
        /**
         * è§†é¢‘æ¨¡å—ç±»
         */
        class VideoModule extends BaseModule {
            constructor(id, fabricObject, properties = {}) {
                super(id, 'VIDEO', fabricObject, properties);
            }
            
            /**
             * è·å–é»˜è®¤å±æ€§
             */
            getDefaultProperties() {
                return {
                    videoUrl: '',
                    posterUrl: '',
                    autoplay: false,
                    muted: true,
                    loop: false,
                    controls: true,
                    playsinline: true,
                    placeholder: 'è¯·è®¾ç½®è§†é¢‘URL'
                };
            }
            
            /**
             * å°†å±æ€§åº”ç”¨åˆ°Fabricå¯¹è±¡
             */
            applyPropertiesToFabric() {
                if (!this.fabricObject) return;
                
                const props = this.properties;
                
                // æ›´æ–°å ä½ç¬¦æ˜¾ç¤º
                if (this.fabricObject.type === 'group') {
                    const textObject = this.fabricObject.getObjects().find(obj => obj.type === 'text');
                    if (textObject) {
                        const displayText = props.videoUrl ? 'ğŸ¬ è§†é¢‘' : props.placeholder;
                        textObject.set('text', displayText);
                    }
                }
                
                // åˆ·æ–°ç”»å¸ƒ
                if (this.fabricObject.canvas) {
                    this.fabricObject.canvas.renderAll();
                }
            }
            
            /**
             * åˆ›å»ºFabricè§†é¢‘å¯¹è±¡ï¼ˆå ä½ç¬¦ï¼‰
             */
            static createFabricObject(options = {}) {
                const defaultOptions = {
                    left: options.left || 50,
                    top: options.top || 50,
                    width: options.width || 200,
                    height: options.height || 120,
                    backgroundColor: '#f3f4f6',
                    borderColor: '#d1d5db',
                    placeholder: options.placeholder || 'è¯·è®¾ç½®è§†é¢‘URL'
                };
                
                // åˆ›å»ºçŸ©å½¢èƒŒæ™¯
                const rect = new fabric.Rect({
                    left: 0,
                    top: 0,
                    width: defaultOptions.width,
                    height: defaultOptions.height,
                    fill: defaultOptions.backgroundColor,
                    stroke: defaultOptions.borderColor,
                    strokeWidth: 2,
                    strokeDashArray: [5, 5]
                });
                
                // åˆ›å»ºæ’­æ”¾å›¾æ ‡
                const playIcon = new fabric.Text('â–¶', {
                    left: defaultOptions.width / 2,
                    top: defaultOptions.height / 2 - 10,
                    fontSize: 24,
                    fill: '#6b7280',
                    textAlign: 'center',
                    originX: 'center',
                    originY: 'center'
                });
                
                // åˆ›å»ºæ–‡æœ¬
                const textObj = new fabric.Text(defaultOptions.placeholder, {
                    left: defaultOptions.width / 2,
                    top: defaultOptions.height / 2 + 20,
                    fontSize: 12,
                    fill: '#6b7280',
                    textAlign: 'center',
                    originX: 'center',
                    originY: 'center'
                });
                
                // åˆ›å»ºç»„åˆå¯¹è±¡
                const group = new fabric.Group([rect, playIcon, textObj], {
                    left: defaultOptions.left,
                    top: defaultOptions.top,
                    selectable: true,
                    hasControls: true,
                    hasBorders: true
                });
                
                return group;
            }
            
            /**
             * åœ¨é¢„è§ˆå®¹å™¨ä¸­æ¸²æŸ“æ¨¡å—
             */
            renderPreview(container, containerWidth, containerHeight) {
                const rect = this.getPercentageRect(containerWidth, containerHeight);
                const props = this.properties;
                
                if (props.videoUrl) {
                    // åˆ›å»ºè§†é¢‘å…ƒç´ 
                    const videoElement = DOMUtils.createElement('video', 'module-preview');
                    videoElement.style.cssText = `
                        position: absolute;
                        left: ${rect.left};
                        top: ${rect.top};
                        width: ${rect.width};
                        height: ${rect.height};
                        object-fit: cover;
                        border-radius: 4px;
                        z-index: 10;
                    `;
                    
                    // è®¾ç½®è§†é¢‘å±æ€§
                    videoElement.src = props.videoUrl;
                    videoElement.controls = props.controls;
                    videoElement.autoplay = props.autoplay;
                    videoElement.muted = props.muted;
                    videoElement.loop = props.loop;
                    videoElement.playsInline = props.playsinline;
                    
                    if (props.posterUrl) {
                        videoElement.poster = props.posterUrl;
                    }
                    
                    videoElement.dataset.moduleId = this.id;
                    videoElement.dataset.moduleType = this.type;
                    
                    // é”™è¯¯å¤„ç†
                    videoElement.addEventListener('error', () => {
                        this.createErrorPlaceholder(container, rect);
                    });
                    
                    return videoElement;
                } else {
                    // åˆ›å»ºå ä½ç¬¦
                    return this.createPlaceholder(rect);
                }
            }
            
            /**
             * åˆ›å»ºå ä½ç¬¦
             */
            createPlaceholder(rect) {
                const placeholder = DOMUtils.createElement('div', 'module-preview');
                placeholder.style.cssText = `
                    position: absolute;
                    left: ${rect.left};
                    top: ${rect.top};
                    width: ${rect.width};
                    height: ${rect.height};
                    background: #f3f4f6;
                    border: 2px dashed #d1d5db;
                    border-radius: 4px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    color: #6b7280;
                    z-index: 10;
                `;
                
                const icon = DOMUtils.createElement('div', '', 'ğŸ¬');
                icon.style.fontSize = '24px';
                icon.style.marginBottom = '8px';
                
                const text = DOMUtils.createElement('div', '', this.properties.placeholder);
                text.style.fontSize = '12px';
                text.style.textAlign = 'center';
                
                placeholder.appendChild(icon);
                placeholder.appendChild(text);
                placeholder.dataset.moduleId = this.id;
                placeholder.dataset.moduleType = this.type;
                
                return placeholder;
            }
            
            /**
             * åˆ›å»ºé”™è¯¯å ä½ç¬¦
             */
            createErrorPlaceholder(container, rect) {
                const errorPlaceholder = DOMUtils.createElement('div', 'module-preview');
                errorPlaceholder.style.cssText = `
                    position: absolute;
                    left: ${rect.left};
                    top: ${rect.top};
                    width: ${rect.width};
                    height: ${rect.height};
                    background: #fef2f2;
                    border: 2px dashed #f87171;
                    border-radius: 4px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    color: #dc2626;
                    z-index: 10;
                `;
                
                const icon = DOMUtils.createElement('div', '', 'âŒ');
                icon.style.fontSize = '24px';
                icon.style.marginBottom = '8px';
                
                const text = DOMUtils.createElement('div', '', 'è§†é¢‘åŠ è½½å¤±è´¥');
                text.style.fontSize = '12px';
                text.style.textAlign = 'center';
                
                errorPlaceholder.appendChild(icon);
                errorPlaceholder.appendChild(text);
                
                return errorPlaceholder;
            }
            
            /**
             * ä»JSONæ•°æ®ååºåˆ—åŒ–è§†é¢‘æ¨¡å—
             */
            static deserialize(data, canvas) {
                const fabricObject = VideoModule.createFabricObject({
                    left: CoordinateUtils.fromPercentage(data.rect.left, canvas ? canvas.width : 375),
                    top: CoordinateUtils.fromPercentage(data.rect.top, canvas ? canvas.height : 667),
                    width: CoordinateUtils.fromPercentage(data.rect.width, canvas ? canvas.width : 375),
                    height: CoordinateUtils.fromPercentage(data.rect.height, canvas ? canvas.height : 667),
                    placeholder: data.properties.placeholder
                });
                
                const module = new VideoModule(data.id, fabricObject, data.properties);
                
                if (canvas) {
                    canvas.add(fabricObject);
                }
                
                return module;
            }
            
            /**
             * éªŒè¯è§†é¢‘æ¨¡å—å±æ€§
             */
            validateProperties() {
                const errors = [];
                const props = this.properties;
                
                if (props.videoUrl && !this.isValidUrl(props.videoUrl)) {
                    errors.push('è§†é¢‘URLæ ¼å¼ä¸æ­£ç¡®');
                }
                
                if (props.posterUrl && !this.isValidUrl(props.posterUrl)) {
                    errors.push('å°é¢å›¾URLæ ¼å¼ä¸æ­£ç¡®');
                }
                
                return {
                    valid: errors.length === 0,
                    errors: errors
                };
            }
            
            /**
             * éªŒè¯URLæ ¼å¼
             */
            isValidUrl(url) {
                try {
                    new URL(url);
                    return true;
                } catch {
                    return false;
                }
            }
            
            /**
             * è·å–å±æ€§é…ç½®è¡¨å•å­—æ®µ
             */
            getPropertyFields() {
                return [
                    {
                        key: 'videoUrl',
                        label: 'è§†é¢‘URL',
                        type: 'url',
                        placeholder: 'https://example.com/video.mp4',
                        required: true
                    },
                    {
                        key: 'posterUrl',
                        label: 'å°é¢å›¾URL',
                        type: 'url',
                        placeholder: 'https://example.com/poster.jpg'
                    },
                    {
                        key: 'autoplay',
                        label: 'è‡ªåŠ¨æ’­æ”¾',
                        type: 'checkbox'
                    },
                    {
                        key: 'muted',
                        label: 'é™éŸ³',
                        type: 'checkbox'
                    },
                    {
                        key: 'loop',
                        label: 'å¾ªç¯æ’­æ”¾',
                        type: 'checkbox'
                    },
                    {
                        key: 'controls',
                        label: 'æ˜¾ç¤ºæ§ä»¶',
                        type: 'checkbox'
                    },
                    {
                        key: 'playsinline',
                        label: 'å†…è”æ’­æ”¾',
                        type: 'checkbox'
                    }
                ];
            }
        }
        
        /**
         * GIFæ¨¡å—ç±»
         */
        class GifModule extends BaseModule {
            constructor(id, fabricObject, properties = {}) {
                super(id, 'GIF', fabricObject, properties);
            }
            
            /**
             * è·å–é»˜è®¤å±æ€§
             */
            getDefaultProperties() {
                return {
                    gifUrl: '',
                    altText: 'GIFåŠ¨å›¾',
                    autoplay: true,
                    loop: true,
                    placeholder: 'è¯·è®¾ç½®GIF URL'
                };
            }
            
            /**
             * å°†å±æ€§åº”ç”¨åˆ°Fabricå¯¹è±¡
             */
            applyPropertiesToFabric() {
                if (!this.fabricObject) return;
                
                const props = this.properties;
                
                // æ›´æ–°å ä½ç¬¦æ˜¾ç¤º
                if (this.fabricObject.type === 'group') {
                    const textObject = this.fabricObject.getObjects().find(obj => obj.type === 'text');
                    if (textObject) {
                        const displayText = props.gifUrl ? 'ğŸï¸ GIF' : props.placeholder;
                        textObject.set('text', displayText);
                    }
                }
                
                // åˆ·æ–°ç”»å¸ƒ
                if (this.fabricObject.canvas) {
                    this.fabricObject.canvas.renderAll();
                }
            }
            
            /**
             * åˆ›å»ºFabric GIFå¯¹è±¡ï¼ˆå ä½ç¬¦ï¼‰
             */
            static createFabricObject(options = {}) {
                const defaultOptions = {
                    left: options.left || 50,
                    top: options.top || 50,
                    width: options.width || 150,
                    height: options.height || 150,
                    backgroundColor: '#f3f4f6',
                    borderColor: '#d1d5db',
                    placeholder: options.placeholder || 'è¯·è®¾ç½®GIF URL'
                };
                
                // åˆ›å»ºçŸ©å½¢èƒŒæ™¯
                const rect = new fabric.Rect({
                    left: 0,
                    top: 0,
                    width: defaultOptions.width,
                    height: defaultOptions.height,
                    fill: defaultOptions.backgroundColor,
                    stroke: defaultOptions.borderColor,
                    strokeWidth: 2,
                    strokeDashArray: [5, 5]
                });
                
                // åˆ›å»ºGIFå›¾æ ‡
                const gifIcon = new fabric.Text('ğŸï¸', {
                    left: defaultOptions.width / 2,
                    top: defaultOptions.height / 2 - 10,
                    fontSize: 24,
                    fill: '#6b7280',
                    textAlign: 'center',
                    originX: 'center',
                    originY: 'center'
                });
                
                // åˆ›å»ºæ–‡æœ¬
                const textObj = new fabric.Text(defaultOptions.placeholder, {
                    left: defaultOptions.width / 2,
                    top: defaultOptions.height / 2 + 20,
                    fontSize: 12,
                    fill: '#6b7280',
                    textAlign: 'center',
                    originX: 'center',
                    originY: 'center'
                });
                
                // åˆ›å»ºç»„åˆå¯¹è±¡
                const group = new fabric.Group([rect, gifIcon, textObj], {
                    left: defaultOptions.left,
                    top: defaultOptions.top,
                    selectable: true,
                    hasControls: true,
                    hasBorders: true
                });
                
                return group;
            }
            
            /**
             * åœ¨é¢„è§ˆå®¹å™¨ä¸­æ¸²æŸ“æ¨¡å—
             */
            renderPreview(container, containerWidth, containerHeight) {
                const rect = this.getPercentageRect(containerWidth, containerHeight);
                const props = this.properties;
                
                if (props.gifUrl) {
                    // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
                    const imgElement = DOMUtils.createElement('img', 'module-preview');
                    imgElement.style.cssText = `
                        position: absolute;
                        left: ${rect.left};
                        top: ${rect.top};
                        width: ${rect.width};
                        height: ${rect.height};
                        object-fit: cover;
                        border-radius: 4px;
                        z-index: 10;
                    `;
                    
                    imgElement.src = props.gifUrl;
                    imgElement.alt = props.altText;
                    imgElement.dataset.moduleId = this.id;
                    imgElement.dataset.moduleType = this.type;
                    
                    // é”™è¯¯å¤„ç†
                    imgElement.addEventListener('error', () => {
                        this.createErrorPlaceholder(container, rect);
                    });
                    
                    return imgElement;
                } else {
                    // åˆ›å»ºå ä½ç¬¦
                    return this.createPlaceholder(rect);
                }
            }
            
            /**
             * åˆ›å»ºå ä½ç¬¦
             */
            createPlaceholder(rect) {
                const placeholder = DOMUtils.createElement('div', 'module-preview');
                placeholder.style.cssText = `
                    position: absolute;
                    left: ${rect.left};
                    top: ${rect.top};
                    width: ${rect.width};
                    height: ${rect.height};
                    background: #f3f4f6;
                    border: 2px dashed #d1d5db;
                    border-radius: 4px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    color: #6b7280;
                    z-index: 10;
                `;
                
                const icon = DOMUtils.createElement('div', '', 'ğŸï¸');
                icon.style.fontSize = '24px';
                icon.style.marginBottom = '8px';
                
                const text = DOMUtils.createElement('div', '', this.properties.placeholder);
                text.style.fontSize = '12px';
                text.style.textAlign = 'center';
                
                placeholder.appendChild(icon);
                placeholder.appendChild(text);
                placeholder.dataset.moduleId = this.id;
                placeholder.dataset.moduleType = this.type;
                
                return placeholder;
            }
            
            /**
             * åˆ›å»ºé”™è¯¯å ä½ç¬¦
             */
            createErrorPlaceholder(container, rect) {
                const errorPlaceholder = DOMUtils.createElement('div', 'module-preview');
                errorPlaceholder.style.cssText = `
                    position: absolute;
                    left: ${rect.left};
                    top: ${rect.top};
                    width: ${rect.width};
                    height: ${rect.height};
                    background: #fef2f2;
                    border: 2px dashed #f87171;
                    border-radius: 4px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    color: #dc2626;
                    z-index: 10;
                `;
                
                const icon = DOMUtils.createElement('div', '', 'âŒ');
                icon.style.fontSize = '24px';
                icon.style.marginBottom = '8px';
                
                const text = DOMUtils.createElement('div', '', 'GIFåŠ è½½å¤±è´¥');
                text.style.fontSize = '12px';
                text.style.textAlign = 'center';
                
                errorPlaceholder.appendChild(icon);
                errorPlaceholder.appendChild(text);
                
                return errorPlaceholder;
            }
            
            /**
             * ä»JSONæ•°æ®ååºåˆ—åŒ–GIFæ¨¡å—
             */
            static deserialize(data, canvas) {
                const fabricObject = GifModule.createFabricObject({
                    left: CoordinateUtils.fromPercentage(data.rect.left, canvas ? canvas.width : 375),
                    top: CoordinateUtils.fromPercentage(data.rect.top, canvas ? canvas.height : 667),
                    width: CoordinateUtils.fromPercentage(data.rect.width, canvas ? canvas.width : 375),
                    height: CoordinateUtils.fromPercentage(data.rect.height, canvas ? canvas.height : 667),
                    placeholder: data.properties.placeholder
                });
                
                const module = new GifModule(data.id, fabricObject, data.properties);
                
                if (canvas) {
                    canvas.add(fabricObject);
                }
                
                return module;
            }
            
            /**
             * éªŒè¯GIFæ¨¡å—å±æ€§
             */
            validateProperties() {
                const errors = [];
                const props = this.properties;
                
                if (props.gifUrl && !this.isValidUrl(props.gifUrl)) {
                    errors.push('GIF URLæ ¼å¼ä¸æ­£ç¡®');
                }
                
                if (!props.altText || props.altText.trim() === '') {
                    errors.push('æ›¿ä»£æ–‡æœ¬ä¸èƒ½ä¸ºç©º');
                }
                
                return {
                    valid: errors.length === 0,
                    errors: errors
                };
            }
            
            /**
             * éªŒè¯URLæ ¼å¼
             */
            isValidUrl(url) {
                try {
                    new URL(url);
                    return true;
                } catch {
                    return false;
                }
            }
            
            /**
             * è·å–å±æ€§é…ç½®è¡¨å•å­—æ®µ
             */
            getPropertyFields() {
                return [
                    {
                        key: 'gifUrl',
                        label: 'GIF URL',
                        type: 'url',
                        placeholder: 'https://example.com/image.gif',
                        required: true
                    },
                    {
                        key: 'altText',
                        label: 'æ›¿ä»£æ–‡æœ¬',
                        type: 'text',
                        placeholder: 'æè¿°GIFå†…å®¹'
                    },
                    {
                        key: 'autoplay',
                        label: 'è‡ªåŠ¨æ’­æ”¾',
                        type: 'checkbox'
                    },
                    {
                        key: 'loop',
                        label: 'å¾ªç¯æ’­æ”¾',
                        type: 'checkbox'
                    }
                ];
            }
        }
        
        console.log('VideoModuleå’ŒGifModuleç±»å·²åŠ è½½');
        
        // ==================== çŠ¶æ€ç®¡ç†ç³»ç»Ÿ ====================
        
        /**
         * åº”ç”¨çŠ¶æ€ç®¡ç†ç±»
         */
        class AppState {
            constructor() {
                this.modules = new Map(); // å­˜å‚¨æ‰€æœ‰æ¨¡å—
                this.selectedModule = null; // å½“å‰é€‰ä¸­çš„æ¨¡å—
                this.backgroundImage = null; // èƒŒæ™¯å›¾ç‰‡ä¿¡æ¯
                this.canvas = null; // Fabric.jsç”»å¸ƒå®ä¾‹
                this.backgroundImageData = null; // èƒŒæ™¯å›¾ç‰‡çš„base64æ•°æ®
                this.backgroundDimensions = { width: 0, height: 0 }; // èƒŒæ™¯å›¾ç‰‡å°ºå¯¸
                this.listeners = new Map(); // äº‹ä»¶ç›‘å¬å™¨
                
                // åˆå§‹åŒ–å…¨å±€çŠ¶æ€
                this.initializeGlobalState();
            }
            
            /**
             * åˆå§‹åŒ–å…¨å±€çŠ¶æ€
             */
            initializeGlobalState() {
                // å°†AppStateå®ä¾‹è®¾ç½®ä¸ºå…¨å±€å¯è®¿é—®
                window.appState = this;
                
                // è®¾ç½®æ¨¡å—å·¥å‚
                this.moduleFactory = {
                    TEXT: TextModule,
                    BUTTON: ButtonModule,
                    VIDEO: VideoModule,
                    GIF: GifModule
                };
                
                console.log('åº”ç”¨çŠ¶æ€ç®¡ç†å·²åˆå§‹åŒ–');
            }
            
            /**
             * æ·»åŠ æ¨¡å—
             */
            addModule(module) {
                if (!(module instanceof BaseModule)) {
                    throw new Error('æ¨¡å—å¿…é¡»æ˜¯BaseModuleçš„å®ä¾‹');
                }
                
                this.modules.set(module.id, module);
                this.emit('moduleAdded', module);
                
                console.log(`æ¨¡å—å·²æ·»åŠ : ${module.type} (${module.id})`);
                return module;
            }
            
            /**
             * ç§»é™¤æ¨¡å—
             */
            removeModule(moduleId) {
                const module = this.modules.get(moduleId);
                if (!module) {
                    console.warn(`æ¨¡å—ä¸å­˜åœ¨: ${moduleId}`);
                    return false;
                }
                
                // å¦‚æœå½“å‰é€‰ä¸­çš„æ¨¡å—è¢«åˆ é™¤ï¼Œå–æ¶ˆé€‰ä¸­
                if (this.selectedModule && this.selectedModule.id === moduleId) {
                    this.selectModule(null);
                }
                
                // ä»ç”»å¸ƒä¸­ç§»é™¤
                if (module.fabricObject && this.canvas) {
                    this.canvas.remove(module.fabricObject);
                }
                
                // æ¸…ç†æ¨¡å—èµ„æº
                module.destroy();
                
                // ä»å­˜å‚¨ä¸­ç§»é™¤
                this.modules.delete(moduleId);
                
                this.emit('moduleRemoved', moduleId);
                console.log(`æ¨¡å—å·²ç§»é™¤: ${moduleId}`);
                return true;
            }
            
            /**
             * é€‰æ‹©æ¨¡å—
             */
            selectModule(moduleId) {
                const previousModule = this.selectedModule;
                
                if (moduleId === null) {
                    this.selectedModule = null;
                } else {
                    const module = this.modules.get(moduleId);
                    if (!module) {
                        console.warn(`æ¨¡å—ä¸å­˜åœ¨: ${moduleId}`);
                        return false;
                    }
                    this.selectedModule = module;
                }
                
                this.emit('moduleSelected', this.selectedModule, previousModule);
                console.log(`æ¨¡å—å·²é€‰ä¸­: ${moduleId}`);
                return true;
            }
            
            /**
             * é€šè¿‡Fabricå¯¹è±¡é€‰æ‹©æ¨¡å—
             */
            selectModuleByFabricObject(fabricObject) {
                if (!fabricObject || !fabricObject.moduleInstance) {
                    this.selectModule(null);
                    return false;
                }
                
                return this.selectModule(fabricObject.moduleInstance.id);
            }
            
            /**
             * è·å–æ¨¡å—
             */
            getModule(moduleId) {
                return this.modules.get(moduleId);
            }
            
            /**
             * è·å–æ‰€æœ‰æ¨¡å—
             */
            getAllModules() {
                return Array.from(this.modules.values());
            }
            
            /**
             * è·å–é€‰ä¸­çš„æ¨¡å—
             */
            getSelectedModule() {
                return this.selectedModule;
            }
            
            /**
             * æ›´æ–°æ¨¡å—å±æ€§
             */
            updateModule(moduleId, properties) {
                const module = this.modules.get(moduleId);
                if (!module) {
                    console.warn(`æ¨¡å—ä¸å­˜åœ¨: ${moduleId}`);
                    return false;
                }
                
                module.updateProperties(properties);
                this.emit('moduleUpdated', module);
                
                console.log(`æ¨¡å—å±æ€§å·²æ›´æ–°: ${moduleId}`);
                return true;
            }
            
            /**
             * è®¾ç½®èƒŒæ™¯å›¾ç‰‡
             */
            setBackgroundImage(imageData, dimensions) {
                this.backgroundImageData = imageData;
                this.backgroundDimensions = dimensions;
                
                if (this.canvas) {
                    this.updateCanvasBackground();
                }
                
                this.emit('backgroundImageChanged', imageData, dimensions);
                console.log(`èƒŒæ™¯å›¾ç‰‡å·²è®¾ç½®: ${dimensions.width}x${dimensions.height}`);
            }
            
            /**
             * æ›´æ–°ç”»å¸ƒèƒŒæ™¯
             */
            updateCanvasBackground() {
                console.log('ğŸ¨ å¼€å§‹æ›´æ–°CanvasèƒŒæ™¯');
                console.log('Canvaså®ä¾‹:', this.canvas);
                console.log('èƒŒæ™¯å›¾ç‰‡æ•°æ®é•¿åº¦:', this.backgroundImageData ? this.backgroundImageData.length : 0);
                console.log('èƒŒæ™¯å›¾ç‰‡å°ºå¯¸:', this.backgroundDimensions);
                
                if (!this.canvas || !this.backgroundImageData) {
                    console.warn('âŒ CanvasèƒŒæ™¯æ›´æ–°å¤±è´¥: Canvasæˆ–èƒŒæ™¯æ•°æ®ä¸ºç©º');
                    return;
                }
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loadingElement = document.getElementById('canvasLoading');
                if (loadingElement) {
                    loadingElement.classList.remove('hidden');
                }
                
                fabric.Image.fromURL(this.backgroundImageData, (img) => {
                    console.log('âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ:', img);
                    
                    // è®¡ç®—ç”»å¸ƒå°ºå¯¸
                    const rawContainerWidth = this.canvas.getElement().parentElement.clientWidth;
                    const containerWidth = rawContainerWidth || 800; // é»˜è®¤å®½åº¦800px
                    console.log('åŸå§‹å®¹å™¨å®½åº¦:', rawContainerWidth);
                    console.log('å®é™…å®¹å™¨å®½åº¦:', containerWidth);
                    console.log('åŸå§‹å›¾ç‰‡å°ºå¯¸:', this.backgroundDimensions);
                    
                    const scale = containerWidth / this.backgroundDimensions.width;
                    console.log('ç¼©æ”¾æ¯”ä¾‹:', scale);
                    
                    const canvasWidth = containerWidth;
                    const canvasHeight = this.backgroundDimensions.height * scale;
                    console.log('è®¡ç®—åCanvaså°ºå¯¸:', { width: canvasWidth, height: canvasHeight });
                    
                    // è®¾ç½®ç”»å¸ƒå°ºå¯¸
                    this.canvas.setDimensions({
                        width: canvasWidth,
                        height: canvasHeight
                    });
                    console.log('âœ… Canvaså°ºå¯¸å·²è®¾ç½®');
                    
                    // è®¾ç½®èƒŒæ™¯å›¾ç‰‡
                    img.set({
                        left: 0,
                        top: 0,
                        scaleX: scale,
                        scaleY: scale,
                        selectable: false,
                        evented: false
                    });
                    console.log('âœ… å›¾ç‰‡å±æ€§å·²è®¾ç½®');
                    
                    this.canvas.setBackgroundImage(img, this.canvas.renderAll.bind(this.canvas));
                    console.log('âœ… CanvasèƒŒæ™¯å›¾ç‰‡å·²è®¾ç½®å¹¶é‡ç»˜');
                    
                    // éšè—åŠ è½½çŠ¶æ€
                    const loadingElement = document.getElementById('canvasLoading');
                    if (loadingElement) {
                        loadingElement.classList.add('hidden');
                    }
                    
                    // è§¦å‘é¢„è§ˆæ›´æ–°
                    this.emit('canvasUpdated');
                    console.log('âœ… é¢„è§ˆæ›´æ–°äº‹ä»¶å·²è§¦å‘');
                }, (error) => {
                    console.error('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥:', error);
                    
                    // éšè—åŠ è½½çŠ¶æ€
                    const loadingElement = document.getElementById('canvasLoading');
                    if (loadingElement) {
                        loadingElement.classList.add('hidden');
                    }
                    
                    alert('èƒŒæ™¯å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            }
            
            /**
             * åˆ›å»ºæ¨¡å—
             */
            createModule(type, fabricObject, properties = {}) {
                const ModuleClass = this.moduleFactory[type];
                if (!ModuleClass) {
                    throw new Error(`æœªçŸ¥çš„æ¨¡å—ç±»å‹: ${type}`);
                }
                
                const module = new ModuleClass(null, fabricObject, properties);
                return this.addModule(module);
            }
            
            /**
             * æ‰¹é‡åˆ›å»ºæ¨¡å—ï¼ˆç”¨äºæ•°æ®å¯¼å…¥ï¼‰
             */
            createModulesFromData(modulesData) {
                const createdModules = [];
                
                for (const moduleData of modulesData) {
                    try {
                        const ModuleClass = this.moduleFactory[moduleData.type];
                        if (!ModuleClass) {
                            console.warn(`æœªçŸ¥çš„æ¨¡å—ç±»å‹: ${moduleData.type}`);
                            continue;
                        }
                        
                        const module = ModuleClass.deserialize(moduleData, this.canvas);
                        this.addModule(module);
                        createdModules.push(module);
                    } catch (error) {
                        console.error(`åˆ›å»ºæ¨¡å—å¤±è´¥:`, error);
                    }
                }
                
                return createdModules;
            }
            
            /**
             * æ¸…ç©ºæ‰€æœ‰æ¨¡å—
             */
            clearAllModules() {
                const moduleIds = Array.from(this.modules.keys());
                
                for (const moduleId of moduleIds) {
                    this.removeModule(moduleId);
                }
                
                this.selectedModule = null;
                this.emit('allModulesCleared');
                
                console.log('æ‰€æœ‰æ¨¡å—å·²æ¸…ç©º');
            }
            
            /**
             * å¯¼å‡ºé…ç½®
             */
            exportConfiguration() {
                const config = {
                    backgroundImageUrl: this.backgroundImageData,
                    backgroundDimensions: { ...this.backgroundDimensions },
                    modules: []
                };
                
                // åºåˆ—åŒ–æ‰€æœ‰æ¨¡å—
                for (const module of this.modules.values()) {
                    try {
                        const moduleData = module.serialize(
                            this.backgroundDimensions.width,
                            this.backgroundDimensions.height
                        );
                        config.modules.push(moduleData);
                    } catch (error) {
                        console.error(`åºåˆ—åŒ–æ¨¡å—å¤±è´¥:`, error);
                    }
                }
                
                return config;
            }
            
            /**
             * å¯¼å…¥é…ç½®
             */
            importConfiguration(config) {
                try {
                    // æ¸…ç©ºå½“å‰çŠ¶æ€
                    this.clearAllModules();
                    
                    // è®¾ç½®èƒŒæ™¯å›¾ç‰‡
                    if (config.backgroundImageUrl && config.backgroundDimensions) {
                        this.setBackgroundImage(config.backgroundImageUrl, config.backgroundDimensions);
                    }
                    
                    // åˆ›å»ºæ¨¡å—
                    if (config.modules && config.modules.length > 0) {
                        this.createModulesFromData(config.modules);
                    }
                    
                    this.emit('configurationImported', config);
                    console.log('é…ç½®å¯¼å…¥æˆåŠŸ');
                    return true;
                } catch (error) {
                    console.error('é…ç½®å¯¼å…¥å¤±è´¥:', error);
                    return false;
                }
            }
            
            /**
             * è·å–ç”»å¸ƒå°ºå¯¸
             */
            getCanvasDimensions() {
                if (!this.canvas) return { width: 0, height: 0 };
                
                return {
                    width: this.canvas.width,
                    height: this.canvas.height
                };
            }
            
            /**
             * è®¾ç½®ç”»å¸ƒå®ä¾‹
             */
            setCanvas(canvas) {
                this.canvas = canvas;
                
                if (this.backgroundImageData) {
                    this.updateCanvasBackground();
                }
                
                console.log('ç”»å¸ƒå®ä¾‹å·²è®¾ç½®');
            }
            
            /**
             * æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
             */
            on(event, callback) {
                if (!this.listeners.has(event)) {
                    this.listeners.set(event, []);
                }
                this.listeners.get(event).push(callback);
            }
            
            /**
             * ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
             */
            off(event, callback) {
                if (!this.listeners.has(event)) return;
                
                const callbacks = this.listeners.get(event);
                const index = callbacks.indexOf(callback);
                if (index !== -1) {
                    callbacks.splice(index, 1);
                }
            }
            
            /**
             * è§¦å‘äº‹ä»¶
             */
            emit(event, ...args) {
                if (!this.listeners.has(event)) return;
                
                const callbacks = this.listeners.get(event);
                for (const callback of callbacks) {
                    try {
                        callback(...args);
                    } catch (error) {
                        console.error(`äº‹ä»¶å¤„ç†å™¨é”™è¯¯ (${event}):`, error);
                    }
                }
            }
            
            /**
             * è·å–ç»Ÿè®¡ä¿¡æ¯
             */
            getStatistics() {
                const stats = {
                    totalModules: this.modules.size,
                    moduleTypes: {},
                    hasBackground: !!this.backgroundImageData,
                    canvasSize: this.getCanvasDimensions()
                };
                
                // ç»Ÿè®¡æ¨¡å—ç±»å‹
                for (const module of this.modules.values()) {
                    stats.moduleTypes[module.type] = (stats.moduleTypes[module.type] || 0) + 1;
                }
                
                return stats;
            }
            
            /**
             * éªŒè¯å½“å‰çŠ¶æ€
             */
            validate() {
                const errors = [];
                
                // éªŒè¯èƒŒæ™¯å›¾ç‰‡
                if (!this.backgroundImageData) {
                    errors.push('æœªè®¾ç½®èƒŒæ™¯å›¾ç‰‡');
                }
                
                // éªŒè¯æ¨¡å—
                for (const module of this.modules.values()) {
                    const validation = module.validateProperties();
                    if (!validation.valid) {
                        errors.push(`æ¨¡å— ${module.id} éªŒè¯å¤±è´¥: ${validation.errors.join(', ')}`);
                    }
                }
                
                return {
                    valid: errors.length === 0,
                    errors: errors
                };
            }
        }
        
        console.log('AppStateç±»å·²åŠ è½½');
        
        // ==================== ç”»å¸ƒç®¡ç†ç³»ç»Ÿ ====================
        
        /**
         * ç”»å¸ƒç®¡ç†å™¨ç±»
         */
        class CanvasManager {
            constructor(canvasElement, appState) {
                this.canvasElement = canvasElement;
                this.appState = appState;
                this.canvas = null;
                this.isDrawing = false;
                this.startPoint = null;
                this.currentRect = null;
                this.dragHint = null;
                this.resizeObserver = null;
                this.createTypeSelector = null;
                
                // åˆå§‹åŒ–ç”»å¸ƒ
                this.initCanvas();
                this.setupEventListeners();
                this.setupResizeObserver();
                
                console.log('ç”»å¸ƒç®¡ç†å™¨å·²åˆå§‹åŒ–');
            }
            
            /**
             * åˆå§‹åŒ–Fabric.jsç”»å¸ƒ
             */
            initCanvas() {
                // åˆ›å»ºFabric.jsç”»å¸ƒ
                this.canvas = new fabric.Canvas(this.canvasElement, {
                    width: this.canvasElement.parentElement.clientWidth,
                    height: 600,
                    backgroundColor: '#ffffff',
                    selection: true,
                    preserveObjectStacking: true
                });
                
                // è®¾ç½®ç”»å¸ƒåˆ°åº”ç”¨çŠ¶æ€
                this.appState.setCanvas(this.canvas);
                
                // è®¾ç½®å…¨å±€å¼•ç”¨
                window.canvas = this.canvas;
                
                // è·å–æ‹–æ‹½æç¤ºå…ƒç´ 
                this.dragHint = document.getElementById('dragHint');
                
                console.log('Fabric.jsç”»å¸ƒå·²åˆå§‹åŒ–');
            }
            
            /**
             * è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
             */
            setupEventListeners() {
                // ç”»å¸ƒé€‰æ‹©äº‹ä»¶
                this.canvas.on('selection:created', (e) => {
                    const activeObject = e.selected[0];
                    this.appState.selectModuleByFabricObject(activeObject);
                });
                
                this.canvas.on('selection:updated', (e) => {
                    const activeObject = e.selected[0];
                    this.appState.selectModuleByFabricObject(activeObject);
                });
                
                this.canvas.on('selection:cleared', () => {
                    this.appState.selectModule(null);
                });
                
                // å¯¹è±¡ä¿®æ”¹äº‹ä»¶
                this.canvas.on('object:modified', (e) => {
                    const fabricObject = e.target;
                    if (fabricObject.moduleInstance) {
                        this.appState.emit('moduleModified', fabricObject.moduleInstance);
                    }
                });
                
                // é¼ æ ‡äº‹ä»¶ - æ‹–æ‹½åˆ›å»ºæ¨¡å—
                this.canvas.on('mouse:down', (e) => {
                    this.handleMouseDown(e);
                });
                
                this.canvas.on('mouse:move', (e) => {
                    this.handleMouseMove(e);
                });
                
                this.canvas.on('mouse:up', (e) => {
                    this.handleMouseUp(e);
                });
                
                // é˜»æ­¢é»˜è®¤çš„æ¡†é€‰è¡Œä¸º
                this.canvas.on('before:selection:created', (e) => {
                    if (this.isDrawing) {
                        return false;
                    }
                });
                
                console.log('ç”»å¸ƒäº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
            }
            
            /**
             * è®¾ç½®å°ºå¯¸ç›‘å¬å™¨
             */
            setupResizeObserver() {
                if (typeof ResizeObserver !== 'undefined') {
                    this.resizeObserver = new ResizeObserver(() => {
                        this.handleResize();
                    });
                    
                    this.resizeObserver.observe(this.canvasElement.parentElement);
                } else {
                    // é™çº§åˆ°çª—å£resizeäº‹ä»¶
                    window.addEventListener('resize', () => {
                        this.handleResize();
                    });
                }
            }
            
            /**
             * å¤„ç†ç”»å¸ƒå°ºå¯¸å˜åŒ–
             */
            handleResize() {
                const container = this.canvasElement.parentElement;
                const containerWidth = container.clientWidth;
                
                if (this.appState.backgroundImageData) {
                    // æœ‰èƒŒæ™¯å›¾ç‰‡æ—¶ï¼ŒæŒ‰æ¯”ä¾‹ç¼©æ”¾
                    const scale = containerWidth / this.appState.backgroundDimensions.width;
                    const newHeight = this.appState.backgroundDimensions.height * scale;
                    
                    this.canvas.setDimensions({
                        width: containerWidth,
                        height: newHeight
                    });
                } else {
                    // æ²¡æœ‰èƒŒæ™¯å›¾ç‰‡æ—¶ï¼Œä¿æŒå›ºå®šé«˜åº¦
                    this.canvas.setDimensions({
                        width: containerWidth,
                        height: 600
                    });
                }
                
                // æ›´æ–°èƒŒæ™¯å›¾ç‰‡
                this.appState.updateCanvasBackground();
                
                console.log(`ç”»å¸ƒå°ºå¯¸å·²æ›´æ–°: ${containerWidth}x${this.canvas.height}`);
            }
            
            /**
             * å¤„ç†é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
             */
            handleMouseDown(e) {
                if (e.target) {
                    // ç‚¹å‡»äº†å·²æœ‰å¯¹è±¡ï¼Œä¸è¿›è¡Œæ‹–æ‹½åˆ›å»º
                    return;
                }
                
                // å¼€å§‹æ‹–æ‹½åˆ›å»º
                this.isDrawing = true;
                this.startPoint = this.canvas.getPointer(e.e);
                
                // ç¦ç”¨ç”»å¸ƒé€‰æ‹©
                this.canvas.selection = false;
                this.canvas.defaultCursor = 'crosshair';
                
                // æ˜¾ç¤ºæ‹–æ‹½æç¤º
                this.showDragHint(this.startPoint.x, this.startPoint.y, 0, 0);
            }
            
            /**
             * å¤„ç†é¼ æ ‡ç§»åŠ¨äº‹ä»¶
             */
            handleMouseMove(e) {
                if (!this.isDrawing) return;
                
                const currentPoint = this.canvas.getPointer(e.e);
                const width = Math.abs(currentPoint.x - this.startPoint.x);
                const height = Math.abs(currentPoint.y - this.startPoint.y);
                
                // æ›´æ–°æ‹–æ‹½æç¤º
                this.showDragHint(
                    Math.min(this.startPoint.x, currentPoint.x),
                    Math.min(this.startPoint.y, currentPoint.y),
                    width,
                    height
                );
            }
            
            /**
             * å¤„ç†é¼ æ ‡æŠ¬èµ·äº‹ä»¶
             */
            handleMouseUp(e) {
                if (!this.isDrawing) return;
                
                this.isDrawing = false;
                
                // æ¢å¤ç”»å¸ƒé€‰æ‹©
                this.canvas.selection = true;
                this.canvas.defaultCursor = 'default';
                
                // éšè—æ‹–æ‹½æç¤º
                this.hideDragHint();
                
                const currentPoint = this.canvas.getPointer(e.e);
                const width = Math.abs(currentPoint.x - this.startPoint.x);
                const height = Math.abs(currentPoint.y - this.startPoint.y);
                
                // æ£€æŸ¥æ˜¯å¦åˆ›å»ºäº†æœ‰æ•ˆçš„åŒºåŸŸ
                if (width > 10 && height > 10) {
                    this.createModuleOnDrag(
                        Math.min(this.startPoint.x, currentPoint.x),
                        Math.min(this.startPoint.y, currentPoint.y),
                        width,
                        height
                    );
                }
                
                this.startPoint = null;
            }
            
            /**
             * æ˜¾ç¤ºæ‹–æ‹½æç¤º
             */
            showDragHint(x, y, width, height) {
                if (!this.dragHint) return;
                
                this.dragHint.style.left = `${x}px`;
                this.dragHint.style.top = `${y}px`;
                this.dragHint.style.width = `${width}px`;
                this.dragHint.style.height = `${height}px`;
                this.dragHint.classList.remove('hidden');
            }
            
            /**
             * éšè—æ‹–æ‹½æç¤º
             */
            hideDragHint() {
                if (this.dragHint) {
                    this.dragHint.classList.add('hidden');
                }
            }
            
            /**
             * æ‹–æ‹½åˆ›å»ºæ¨¡å—
             */
            createModuleOnDrag(x, y, width, height) {
                // æ˜¾ç¤ºæ¨¡å—ç±»å‹é€‰æ‹©å™¨
                this.showModuleTypeSelector(x, y, width, height);
            }
            
            /**
             * æ˜¾ç¤ºæ¨¡å—ç±»å‹é€‰æ‹©å™¨
             */
            showModuleTypeSelector(x, y, width, height) {
                // ç§»é™¤å·²å­˜åœ¨çš„é€‰æ‹©å™¨
                if (this.createTypeSelector) {
                    this.createTypeSelector.remove();
                }
                
                // åˆ›å»ºé€‰æ‹©å™¨
                this.createTypeSelector = document.createElement('div');
                this.createTypeSelector.className = 'absolute bg-white border border-gray-300 rounded-lg shadow-lg p-4 z-50';
                this.createTypeSelector.style.left = `${x}px`;
                this.createTypeSelector.style.top = `${y + height + 10}px`;
                
                // æ·»åŠ æ ‡é¢˜
                const title = document.createElement('div');
                title.className = 'text-sm font-semibold text-gray-700 mb-2';
                title.textContent = 'é€‰æ‹©æ¨¡å—ç±»å‹';
                this.createTypeSelector.appendChild(title);
                
                // æ·»åŠ ç±»å‹é€‰é¡¹
                const types = [
                    { value: 'TEXT', label: 'ğŸ“ æ–‡æœ¬', icon: 'ğŸ“' },
                    { value: 'BUTTON', label: 'ğŸ”˜ æŒ‰é’®', icon: 'ğŸ”˜' },
                    { value: 'VIDEO', label: 'ğŸ¬ è§†é¢‘', icon: 'ğŸ¬' },
                    { value: 'GIF', label: 'ğŸï¸ GIF', icon: 'ğŸï¸' }
                ];
                
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'grid grid-cols-2 gap-2';
                
                types.forEach(type => {
                    const button = document.createElement('button');
                    button.className = 'flex items-center gap-2 px-3 py-2 text-sm border border-gray-200 rounded hover:bg-gray-50 transition-colors';
                    button.innerHTML = `<span>${type.icon}</span><span>${type.label}</span>`;
                    
                    button.addEventListener('click', () => {
                        this.createModuleWithType(type.value, x, y, width, height);
                        this.hideModuleTypeSelector();
                    });
                    
                    buttonContainer.appendChild(button);
                });
                
                this.createTypeSelector.appendChild(buttonContainer);
                
                // æ·»åŠ å–æ¶ˆæŒ‰é’®
                const cancelButton = document.createElement('button');
                cancelButton.className = 'w-full mt-2 px-3 py-2 text-sm text-gray-600 border border-gray-200 rounded hover:bg-gray-50 transition-colors';
                cancelButton.textContent = 'å–æ¶ˆ';
                cancelButton.addEventListener('click', () => {
                    this.hideModuleTypeSelector();
                });
                
                this.createTypeSelector.appendChild(cancelButton);
                
                // æ·»åŠ åˆ°ç”»å¸ƒå®¹å™¨
                this.canvasElement.parentElement.appendChild(this.createTypeSelector);
                
                // ç‚¹å‡»å¤–éƒ¨å…³é—­
                const handleOutsideClick = (e) => {
                    if (!this.createTypeSelector.contains(e.target)) {
                        this.hideModuleTypeSelector();
                        document.removeEventListener('click', handleOutsideClick);
                    }
                };
                
                setTimeout(() => {
                    document.addEventListener('click', handleOutsideClick);
                }, 100);
            }
            
            /**
             * éšè—æ¨¡å—ç±»å‹é€‰æ‹©å™¨
             */
            hideModuleTypeSelector() {
                if (this.createTypeSelector) {
                    this.createTypeSelector.remove();
                    this.createTypeSelector = null;
                }
            }
            
            /**
             * åˆ›å»ºæŒ‡å®šç±»å‹çš„æ¨¡å—
             */
            createModuleWithType(type, x, y, width, height) {
                try {
                    let fabricObject;
                    
                    switch (type) {
                        case 'TEXT':
                            fabricObject = TextModule.createFabricObject('æ–°æ–‡æœ¬', {
                                left: x,
                                top: y,
                                width: width,
                                height: height
                            });
                            break;
                        case 'BUTTON':
                            fabricObject = ButtonModule.createFabricObject('æ–°æŒ‰é’®', {
                                left: x,
                                top: y,
                                width: width,
                                height: height
                            });
                            break;
                        case 'VIDEO':
                            fabricObject = VideoModule.createFabricObject({
                                left: x,
                                top: y,
                                width: width,
                                height: height
                            });
                            break;
                        case 'GIF':
                            fabricObject = GifModule.createFabricObject({
                                left: x,
                                top: y,
                                width: width,
                                height: height
                            });
                            break;
                        default:
                            throw new Error(`æœªçŸ¥çš„æ¨¡å—ç±»å‹: ${type}`);
                    }
                    
                    // æ·»åŠ åˆ°ç”»å¸ƒ
                    this.canvas.add(fabricObject);
                    
                    // åˆ›å»ºæ¨¡å—å®ä¾‹
                    const module = this.appState.createModule(type, fabricObject);
                    
                    // é€‰ä¸­æ–°åˆ›å»ºçš„æ¨¡å—
                    this.canvas.setActiveObject(fabricObject);
                    this.appState.selectModule(module.id);
                    
                    // åˆ·æ–°ç”»å¸ƒ
                    this.canvas.renderAll();
                    
                    console.log(`æ¨¡å—å·²åˆ›å»º: ${type} (${module.id})`);
                } catch (error) {
                    console.error('åˆ›å»ºæ¨¡å—å¤±è´¥:', error);
                }
            }
            
            /**
             * æ›´æ–°èƒŒæ™¯å›¾ç‰‡
             */
            updateBackgroundImage(imageData, dimensions) {
                this.appState.setBackgroundImage(imageData, dimensions);
            }
            
            /**
             * åŒæ­¥é¢„è§ˆ
             */
            syncWithPreview() {
                this.appState.emit('canvasUpdated');
            }
            
            /**
             * æ¸…ç©ºç”»å¸ƒ
             */
            clearCanvas() {
                this.canvas.clear();
                this.appState.clearAllModules();
                
                // é‡æ–°è®¾ç½®èƒŒæ™¯
                if (this.appState.backgroundImageData) {
                    this.appState.updateCanvasBackground();
                }
                
                console.log('ç”»å¸ƒå·²æ¸…ç©º');
            }
            
            /**
             * è·å–ç”»å¸ƒæ•°æ®URL
             */
            getCanvasDataURL(options = {}) {
                return this.canvas.toDataURL(options);
            }
            
            /**
             * è·å–ç”»å¸ƒJSONæ•°æ®
             */
            getCanvasJSON() {
                return this.canvas.toJSON();
            }
            
            /**
             * ä»JSONæ•°æ®åŠ è½½ç”»å¸ƒ
             */
            loadFromJSON(jsonData) {
                this.canvas.loadFromJSON(jsonData, () => {
                    this.canvas.renderAll();
                    console.log('ç”»å¸ƒå·²ä»JSONåŠ è½½');
                });
            }
            
            /**
             * é”€æ¯ç”»å¸ƒç®¡ç†å™¨
             */
            destroy() {
                if (this.resizeObserver) {
                    this.resizeObserver.disconnect();
                }
                
                if (this.createTypeSelector) {
                    this.createTypeSelector.remove();
                }
                
                if (this.canvas) {
                    this.canvas.dispose();
                }
                
                console.log('ç”»å¸ƒç®¡ç†å™¨å·²é”€æ¯');
            }
        }
        
        console.log('CanvasManagerç±»å·²åŠ è½½');
        
        // ==================== åº”ç”¨ç¨‹åºåˆå§‹åŒ– ====================
        
        /**
         * åº”ç”¨ç¨‹åºä¸»ç±»
         */
        class Application {
            constructor() {
                this.appState = null;
                this.canvasManager = null;
                this.propertyPanel = null;
                this.previewManager = null;
                
                // åˆå§‹åŒ–åº”ç”¨
                this.init();
            }
            
            /**
             * åˆå§‹åŒ–åº”ç”¨ç¨‹åº
             */
            init() {
                // ç­‰å¾…DOMåŠ è½½å®Œæˆ
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        this.initializeApp();
                    });
                } else {
                    this.initializeApp();
                }
            }
            
            /**
             * åˆå§‹åŒ–åº”ç”¨ç¨‹åº
             */
            initializeApp() {
                try {
                    // åˆå§‹åŒ–çŠ¶æ€ç®¡ç†
                    this.appState = new AppState();
                    
                    // åˆå§‹åŒ–ç”»å¸ƒç®¡ç†å™¨
                    const canvasElement = document.getElementById('fabricCanvas');
                    this.canvasManager = new CanvasManager(canvasElement, this.appState);
                    
                    // è®¾ç½®å…¨å±€å¼•ç”¨
                    window.app = this;
                    window.canvasManager = this.canvasManager;
                    
                    // åˆå§‹åŒ–UIäº‹ä»¶
                    this.initializeUIEvents();
                    
                    // åˆå§‹åŒ–åº”ç”¨çŠ¶æ€ç›‘å¬
                    this.initializeAppStateListeners();
                    
                    console.log('åº”ç”¨ç¨‹åºåˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    console.error('åº”ç”¨ç¨‹åºåˆå§‹åŒ–å¤±è´¥:', error);
                }
            }
            
            /**
             * åˆå§‹åŒ–UIäº‹ä»¶
             */
            initializeUIEvents() {
                // èƒŒæ™¯å›¾ä¸Šä¼ 
                this.initBackgroundUpload();
                
                // ä¿å­˜é…ç½®
                this.initSaveConfig();
                
                // é¢„è§ˆæ§åˆ¶
                this.initPreviewControls();
                
                // é…ç½®å¯¼å‡ºå¼¹çª—
                this.initConfigModal();
                
                console.log('UIäº‹ä»¶å·²åˆå§‹åŒ–');
            }
            
            /**
             * åˆå§‹åŒ–èƒŒæ™¯å›¾ä¸Šä¼ 
             */
            initBackgroundUpload() {
                const uploadBtn = document.getElementById('uploadBtn');
                const uploadInput = document.getElementById('backgroundUpload');
                
                // ç‚¹å‡»ä¸Šä¼ æŒ‰é’®
                uploadBtn.addEventListener('click', () => {
                    uploadInput.click();
                });
                
                // æ–‡ä»¶é€‰æ‹©
                uploadInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    try {
                        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                        uploadBtn.disabled = true;
                        uploadBtn.innerHTML = '<span class="loading"></span> ä¸Šä¼ ä¸­...';
                        
                        // éªŒè¯æ–‡ä»¶
                        if (!FileUtils.validateImageFile(file)) {
                            throw new Error('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ï¼ˆJPGã€PNGã€GIFã€WebPï¼‰');
                        }
                        
                        if (!FileUtils.validateFileSize(file)) {
                            throw new Error('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                        }
                        
                        // è½¬æ¢ä¸ºbase64
                        const base64Data = await FileUtils.fileToBase64(file);
                        
                        // è·å–å›¾ç‰‡å°ºå¯¸
                        const dimensions = await this.getImageDimensions(base64Data);
                        
                        // è®¾ç½®èƒŒæ™¯å›¾ç‰‡
                        console.log('ğŸ“¸ å¼€å§‹è®¾ç½®CanvasèƒŒæ™¯å›¾ç‰‡...');
                        this.canvasManager.updateBackgroundImage(base64Data, dimensions);
                        
                        // æ›´æ–°é¢„è§ˆèƒŒæ™¯
                        this.updatePreviewBackground(base64Data);
                        
                        console.log(`âœ… èƒŒæ™¯å›¾ç‰‡ä¸Šä¼ å®Œæˆ: ${dimensions.width}x${dimensions.height}`);
                        
                    } catch (error) {
                        console.error('èƒŒæ™¯å›¾ä¸Šä¼ å¤±è´¥:', error);
                        alert(error.message || 'èƒŒæ™¯å›¾ä¸Šä¼ å¤±è´¥');
                    } finally {
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        uploadBtn.disabled = false;
                        uploadBtn.innerHTML = 'ä¸Šä¼ èƒŒæ™¯å›¾';
                        
                        // æ¸…ç©ºinput
                        uploadInput.value = '';
                    }
                });
            }
            
            /**
             * è·å–å›¾ç‰‡å°ºå¯¸
             */
            getImageDimensions(imageSrc) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        resolve({
                            width: img.naturalWidth,
                            height: img.naturalHeight
                        });
                    };
                    img.onerror = reject;
                    img.src = imageSrc;
                });
            }
            
            /**
             * æ›´æ–°é¢„è§ˆèƒŒæ™¯
             */
            updatePreviewBackground(imageData) {
                const previewBackground = document.getElementById('previewBackground');
                if (previewBackground) {
                    previewBackground.style.backgroundImage = `url(${imageData})`;
                    previewBackground.style.backgroundSize = 'cover';
                    previewBackground.style.backgroundPosition = 'center';
                    previewBackground.innerHTML = '';
                }
            }
            
            /**
             * åˆå§‹åŒ–ä¿å­˜é…ç½®
             */
            initSaveConfig() {
                const saveBtn = document.getElementById('saveConfigBtn');
                
                saveBtn.addEventListener('click', () => {
                    try {
                        // éªŒè¯å½“å‰çŠ¶æ€
                        const validation = this.appState.validate();
                        if (!validation.valid) {
                            alert('é…ç½®éªŒè¯å¤±è´¥:\\n' + validation.errors.join('\\n'));
                            return;
                        }
                        
                        // å¯¼å‡ºé…ç½®
                        const config = this.appState.exportConfiguration();
                        
                        // æ ¼å¼åŒ–JSON
                        const configJson = JSON.stringify(config, null, 2);
                        
                        // æ˜¾ç¤ºé…ç½®å¼¹çª—
                        this.showConfigModal(configJson);
                        
                    } catch (error) {
                        console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                        alert('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message);
                    }
                });
            }
            
            /**
             * æ˜¾ç¤ºé…ç½®å¼¹çª—
             */
            showConfigModal(configJson) {
                const modal = document.getElementById('configModal');
                const output = document.getElementById('configOutput');
                
                output.value = configJson;
                DOMUtils.toggleVisibility(modal, true);
            }
            
            /**
             * åˆå§‹åŒ–é¢„è§ˆæ§åˆ¶
             */
            initPreviewControls() {
                const refreshBtn = document.getElementById('previewRefreshBtn');
                const resetBtn = document.getElementById('previewResetBtn');
                
                refreshBtn.addEventListener('click', () => {
                    this.refreshPreview();
                });
                
                resetBtn.addEventListener('click', () => {
                    this.resetPreview();
                });
            }
            
            /**
             * åˆ·æ–°é¢„è§ˆ
             */
            refreshPreview() {
                // è§¦å‘é¢„è§ˆæ›´æ–°
                this.appState.emit('canvasUpdated');
                console.log('é¢„è§ˆå·²åˆ·æ–°');
            }
            
            /**
             * é‡ç½®é¢„è§ˆ
             */
            resetPreview() {
                const previewModules = document.getElementById('previewModules');
                DOMUtils.clearContainer(previewModules);
                
                // é‡æ–°æ¸²æŸ“æ‰€æœ‰æ¨¡å—
                this.renderAllModulesToPreview();
                console.log('é¢„è§ˆå·²é‡ç½®');
            }
            
            /**
             * æ¸²æŸ“æ‰€æœ‰æ¨¡å—åˆ°é¢„è§ˆ
             */
            renderAllModulesToPreview() {
                const previewModules = document.getElementById('previewModules');
                const previewContainer = document.getElementById('previewContainer');
                
                // æ¸…ç©ºç°æœ‰æ¨¡å—
                DOMUtils.clearContainer(previewModules);
                
                // è·å–é¢„è§ˆå®¹å™¨å°ºå¯¸
                const containerWidth = previewContainer.offsetWidth;
                const containerHeight = previewContainer.offsetHeight;
                
                // æ¸²æŸ“æ¯ä¸ªæ¨¡å—
                for (const module of this.appState.getAllModules()) {
                    try {
                        const moduleElement = module.renderPreview(
                            previewModules,
                            containerWidth,
                            containerHeight
                        );
                        
                        if (moduleElement) {
                            previewModules.appendChild(moduleElement);
                        }
                    } catch (error) {
                        console.error(`æ¸²æŸ“æ¨¡å—å¤±è´¥ (${module.id}):`, error);
                    }
                }
            }
            
            /**
             * åˆå§‹åŒ–é…ç½®å¼¹çª—
             */
            initConfigModal() {
                const modal = document.getElementById('configModal');
                const closeBtn = document.getElementById('closeModalBtn');
                const copyBtn = document.getElementById('copyConfigBtn');
                const downloadBtn = document.getElementById('downloadConfigBtn');
                const output = document.getElementById('configOutput');
                
                // å…³é—­å¼¹çª—
                closeBtn.addEventListener('click', () => {
                    DOMUtils.toggleVisibility(modal, false);
                });
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        DOMUtils.toggleVisibility(modal, false);
                    }
                });
                
                // å¤åˆ¶é…ç½®
                copyBtn.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(output.value);
                        copyBtn.textContent = 'å·²å¤åˆ¶';
                        setTimeout(() => {
                            copyBtn.textContent = 'å¤åˆ¶é…ç½®';
                        }, 2000);
                    } catch (error) {
                        console.error('å¤åˆ¶å¤±è´¥:', error);
                        
                        // é™çº§æ–¹æ¡ˆ
                        output.select();
                        document.execCommand('copy');
                        copyBtn.textContent = 'å·²å¤åˆ¶';
                        setTimeout(() => {
                            copyBtn.textContent = 'å¤åˆ¶é…ç½®';
                        }, 2000);
                    }
                });
                
                // ä¸‹è½½é…ç½®
                downloadBtn.addEventListener('click', () => {
                    const blob = new Blob([output.value], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `page-config-${new Date().toISOString().slice(0, 10)}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                });
            }
            
            /**
             * åˆå§‹åŒ–åº”ç”¨çŠ¶æ€ç›‘å¬
             */
            initializeAppStateListeners() {
                // ç›‘å¬æ¨¡å—æ·»åŠ 
                this.appState.on('moduleAdded', (module) => {
                    this.renderAllModulesToPreview();
                });
                
                // ç›‘å¬æ¨¡å—ç§»é™¤
                this.appState.on('moduleRemoved', (moduleId) => {
                    this.renderAllModulesToPreview();
                });
                
                // ç›‘å¬æ¨¡å—é€‰æ‹©
                this.appState.on('moduleSelected', (selectedModule, previousModule) => {
                    this.updatePropertyPanel(selectedModule);
                });
                
                // ç›‘å¬æ¨¡å—æ›´æ–°
                this.appState.on('moduleUpdated', (module) => {
                    this.renderAllModulesToPreview();
                });
                
                // ç›‘å¬ç”»å¸ƒæ›´æ–°
                this.appState.on('canvasUpdated', () => {
                    this.renderAllModulesToPreview();
                });
                
                // ç›‘å¬æ¨¡å—ä¿®æ”¹
                this.appState.on('moduleModified', (module) => {
                    this.renderAllModulesToPreview();
                });
                
                console.log('åº”ç”¨çŠ¶æ€ç›‘å¬å™¨å·²åˆå§‹åŒ–');
            }
            
            /**
             * æ›´æ–°å±æ€§é¢æ¿
             */
            updatePropertyPanel(selectedModule) {
                const propertyContent = document.getElementById('propertyContent');
                
                if (!selectedModule) {
                    // æ˜¾ç¤ºé»˜è®¤æç¤º
                    propertyContent.innerHTML = `
                        <div class="alert alert-info">
                            <p>è¯·åœ¨å·¦ä¾§ç”»å¸ƒä¸­æ‹–æ‹½åˆ›å»ºæˆ–é€‰æ‹©ä¸€ä¸ªæ¨¡å—</p>
                        </div>
                    `;
                    return;
                }
                
                // ç”Ÿæˆå±æ€§ç¼–è¾‘ç•Œé¢
                this.generatePropertyEditor(selectedModule, propertyContent);
            }
            
            /**
             * ç”Ÿæˆå±æ€§ç¼–è¾‘å™¨
             */
            generatePropertyEditor(module, container) {
                // æ¸…ç©ºå®¹å™¨
                DOMUtils.clearContainer(container);
                
                // åˆ›å»ºæ ‡é¢˜
                const title = DOMUtils.createElement('div', 'flex items-center gap-2 mb-4 p-3 bg-gray-50 rounded-lg');
                title.innerHTML = `
                    <span class="text-lg">${module.getIcon()}</span>
                    <div>
                        <h3 class="font-semibold text-gray-900">${module.getDisplayName()}</h3>
                        <p class="text-sm text-gray-600">ID: ${module.id}</p>
                    </div>
                `;
                container.appendChild(title);
                
                // åˆ›å»ºè¡¨å•
                const form = DOMUtils.createElement('form', 'space-y-4');
                
                // è·å–å±æ€§å­—æ®µ
                const fields = module.getPropertyFields();
                
                // ç”Ÿæˆå­—æ®µ
                fields.forEach(field => {
                    const fieldElement = this.createFormField(field, module);
                    form.appendChild(fieldElement);
                });
                
                // å¦‚æœæ˜¯æŒ‰é’®æ¨¡å—ï¼Œæ·»åŠ åŠ¨æ€å­—æ®µ
                if (module.type === 'BUTTON' && module.getDynamicFields) {
                    const dynamicFields = module.getDynamicFields();
                    dynamicFields.forEach(field => {
                        const fieldElement = this.createFormField(field, module);
                        form.appendChild(fieldElement);
                    });
                }
                
                container.appendChild(form);
                
                // æ·»åŠ åˆ é™¤æŒ‰é’®
                const deleteBtn = DOMUtils.createElement('button', 'btn-danger w-full mt-4');
                deleteBtn.textContent = 'åˆ é™¤æ­¤æ¨¡å—';
                deleteBtn.addEventListener('click', () => {
                    if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ¨¡å—å—ï¼Ÿ')) {
                        this.appState.removeModule(module.id);
                    }
                });
                container.appendChild(deleteBtn);
            }
            
            /**
             * åˆ›å»ºè¡¨å•å­—æ®µ
             */
            createFormField(field, module) {
                const fieldGroup = DOMUtils.createElement('div', 'form-group');
                
                // åˆ›å»ºæ ‡ç­¾
                const label = DOMUtils.createElement('label', 'form-label');
                label.textContent = field.label;
                if (field.required) label.textContent += ' *';
                fieldGroup.appendChild(label);
                
                // è·å–å½“å‰å€¼
                const currentValue = this.getNestedValue(module.properties, field.key);
                
                // åˆ›å»ºè¾“å…¥æ§ä»¶
                let input;
                switch (field.type) {
                    case 'text':
                    case 'url':
                        input = DOMUtils.createElement('input', 'form-input');
                        input.type = field.type;
                        input.value = currentValue || '';
                        input.placeholder = field.placeholder || '';
                        break;
                    case 'textarea':
                        input = DOMUtils.createElement('textarea', 'form-input');
                        input.value = currentValue || '';
                        input.placeholder = field.placeholder || '';
                        input.rows = 3;
                        break;
                    case 'number':
                        input = DOMUtils.createElement('input', 'form-input');
                        input.type = 'number';
                        input.value = currentValue || 0;
                        if (field.min !== undefined) input.min = field.min;
                        if (field.max !== undefined) input.max = field.max;
                        if (field.step !== undefined) input.step = field.step;
                        break;
                    case 'color':
                        input = DOMUtils.createElement('input', 'form-input');
                        input.type = 'color';
                        input.value = currentValue || '#000000';
                        break;
                    case 'select':
                        input = DOMUtils.createElement('select', 'form-select');
                        field.options.forEach(option => {
                            const optionElement = DOMUtils.createElement('option');
                            optionElement.value = option.value;
                            optionElement.textContent = option.label;
                            if (currentValue === option.value) {
                                optionElement.selected = true;
                            }
                            input.appendChild(optionElement);
                        });
                        break;
                    case 'checkbox':
                        input = DOMUtils.createElement('input', 'mr-2');
                        input.type = 'checkbox';
                        input.checked = currentValue || false;
                        break;
                    default:
                        input = DOMUtils.createElement('input', 'form-input');
                        input.type = 'text';
                        input.value = currentValue || '';
                        break;
                }
                
                // æ·»åŠ å•ä½æ ‡ç­¾
                if (field.unit) {
                    const unitWrapper = DOMUtils.createElement('div', 'flex items-center gap-2');
                    unitWrapper.appendChild(input);
                    unitWrapper.appendChild(DOMUtils.createElement('span', 'text-sm text-gray-600', field.unit));
                    fieldGroup.appendChild(unitWrapper);
                } else {
                    fieldGroup.appendChild(input);
                }
                
                // æ·»åŠ äº‹ä»¶ç›‘å¬
                input.addEventListener('input', (e) => {
                    let value = e.target.value;
                    
                    // ç±»å‹è½¬æ¢
                    if (field.type === 'number') {
                        value = parseFloat(value) || 0;
                    } else if (field.type === 'checkbox') {
                        value = e.target.checked;
                    }
                    
                    // æ›´æ–°å±æ€§
                    const updateData = {};
                    this.setNestedValue(updateData, field.key, value);
                    this.appState.updateModule(module.id, updateData);
                });
                
                return fieldGroup;
            }
            
            /**
             * è·å–åµŒå¥—å€¼
             */
            getNestedValue(obj, path) {
                return path.split('.').reduce((current, key) => {
                    return current && current[key] !== undefined ? current[key] : undefined;
                }, obj);
            }
            
            /**
             * è®¾ç½®åµŒå¥—å€¼
             */
            setNestedValue(obj, path, value) {
                const keys = path.split('.');
                const lastKey = keys.pop();
                const target = keys.reduce((current, key) => {
                    return current[key] = current[key] || {};
                }, obj);
                target[lastKey] = value;
            }
        }
        
        // åˆ›å»ºåº”ç”¨å®ä¾‹
        const app = new Application();
        
        console.log('åº”ç”¨ç¨‹åºå·²å¯åŠ¨');
    </script>
</body>
</html> 